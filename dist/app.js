// Route Plotter v3 - Production Build
// Built: 2025-11-14T13:50:15.910Z

var J=Object.defineProperty,Z=Object.defineProperties;var Q=Object.getOwnPropertyDescriptors;var $=Object.getOwnPropertySymbols;var ee=Object.prototype.hasOwnProperty,te=Object.prototype.propertyIsEnumerable;var K=(b,e,t)=>e in b?J(b,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):b[e]=t,w=(b,e)=>{for(var t in e||(e={}))ee.call(e,t)&&K(b,t,e[t]);if($)for(var t of $(e))te.call(e,t)&&K(b,t,e[t]);return b},W=(b,e)=>Z(b,Q(e));var _=class b{static interpolate(e,t,s,n,i,a){let o=i*i,h=o*i,r=(s.x-e.x)*a,l=(s.y-e.y)*a,u=(n.x-t.x)*a,c=(n.y-t.y)*a,g=s.x-t.x,y=s.y-t.y;return{x:t.x+r*i+(3*g-2*r-u)*o+(2*-g+r+u)*h,y:t.y+l*i+(3*y-2*l-c)*o+(2*-y+l+c)*h}}static createPath(e,t=30,s=.5){if(e.length<2)return[];let n=[],i=e.length-1,a=1/t;for(let o=0;o<i;o++){let h=e[o===0?0:o-1],r=e[o],l=e[o+1],u=e[o===i-1?i:o+2];for(let c=0;c<t;c++)n.push(b.interpolate(h,r,l,u,c*a,s))}return n.push(e[i]),n}};var I=class{static quadIn(e){return e*e}static cubicOut(e){let t=e-1;return t*t*t+1}static cubicInOut(e){return e<.5?4*e*e*e:1+4*(e-1)*(e-1)*(e-1)}};var C={DEFAULT_DURATION:1e4,DEFAULT_SPEED:400,TARGET_FPS:60,FRAME_INTERVAL:16.666666666666668,MAX_DELTA_TIME:100,DEFAULT_PLAYBACK_SPEED:1,DEFAULT_WAIT_TIME:0,TIMELINE_RESOLUTION:1e3},S={DEFAULT_PATH_COLOR:"#FF6B6B",DEFAULT_PATH_THICKNESS:3,DEFAULT_DOT_SIZE:8,MINOR_DOT_SIZE:4,PATH_HEAD_SIZE:8,BEACON_PULSE_DURATION:2e3,BEACON_MAX_RADIUS:30,BEACON_PULSE_SIZE:10,BEACON_PULSE_OPACITY:.4,BEACON_RIPPLE_DURATION:1500,BEACON_RIPPLE_INTERVAL:500,BEACON_RIPPLE_SPEED:30,LABEL_OFFSET_X:10,LABEL_OFFSET_Y:5,LABEL_FONT_SIZE:14,LABEL_FADE_TIME:2e3,SQUIGGLE_AMPLITUDE:.15,RANDOMISED_JITTER:3,CONTROLS_HEIGHT:80},A={POINTS_PER_SEGMENT:100,DEFAULT_TENSION:.2,TARGET_SPACING:2,MAX_CURVATURE:.1,MIN_CORNER_SPEED:.2,CORNER_THRESHOLD:30,CORNER_SLOW_RADIUS:15,CORNER_SLOW_FACTOR:.7},G={WAYPOINT_HIT_RADIUS:15,DRAG_THRESHOLD:3,DOUBLE_CLICK_TIME:300,LONG_PRESS_TIME:500,ZOOM_SENSITIVITY:.001,PAN_SENSITIVITY:1},P={AUTOSAVE_KEY:"routePlotter_autosave",PREFERENCES_KEY:"routePlotter_preferences",SPLASH_SHOWN_KEY:"routePlotter_splashShown",AUTOSAVE_INTERVAL:1e3};var D=class{constructor(){this.debounceTimer=null,this._lastSerialized=null}save(e,t){try{let s=JSON.stringify(t);return localStorage.setItem(e,s),!0}catch(s){return console.error("Failed to save to localStorage (".concat(e,"):"),s),!1}}load(e,t=null){try{let s=localStorage.getItem(e);return s===null?t:JSON.parse(s)}catch(s){return console.error("Failed to load from localStorage (".concat(e,"):"),s),t}}remove(e){try{return localStorage.removeItem(e),!0}catch(t){return console.error("Failed to remove from localStorage (".concat(e,"):"),t),!1}}exists(e){try{return localStorage.getItem(e)!==null}catch(t){return console.error("Failed to check localStorage (".concat(e,"):"),t),!1}}autoSave(e){let t=JSON.stringify(e);t!==this._lastSerialized&&(this.debounceTimer&&clearTimeout(this.debounceTimer),this.debounceTimer=setTimeout(()=>{this.save(P.AUTOSAVE_KEY,e),this._lastSerialized=t,console.log("Auto-saved state")},P.AUTOSAVE_INTERVAL))}loadAutoSave(){return this.load(P.AUTOSAVE_KEY,null)}clearAutoSave(){return this.remove(P.AUTOSAVE_KEY)}savePreferences(e){return this.save(P.PREFERENCES_KEY,e)}loadPreferences(){return this.load(P.PREFERENCES_KEY,{showSplash:!0,theme:"light",animationSpeed:1,autoSave:!0,keyboardShortcuts:!0,highContrast:!1})}shouldShowSplash(){return!this.exists(P.SPLASH_SHOWN_KEY)}markSplashShown(){this.save(P.SPLASH_SHOWN_KEY,!0)}exportData(){let e={autosave:this.loadAutoSave(),preferences:this.loadPreferences(),timestamp:new Date().toISOString()};return JSON.stringify(e,null,2)}importData(e){try{let t=JSON.parse(e);return t.autosave&&this.save(P.AUTOSAVE_KEY,t.autosave),t.preferences&&this.save(P.PREFERENCES_KEY,t.preferences),!0}catch(t){return console.error("Failed to import data:",t),!1}}clearAll(){try{return[P.AUTOSAVE_KEY,P.PREFERENCES_KEY,P.SPLASH_SHOWN_KEY].forEach(t=>this.remove(t)),!0}catch(e){return console.error("Failed to clear all data:",e),!1}}async getStorageInfo(){if("storage"in navigator&&"estimate"in navigator.storage)try{let e=await navigator.storage.estimate();return{usage:e.usage,quota:e.quota,percentage:e.usage/e.quota*100}}catch(e){console.error("Failed to estimate storage:",e)}return null}};var O=class{constructor(){this.canvasWidth=0,this.canvasHeight=0,this.imageWidth=0,this.imageHeight=0,this.imageBounds=null,this.fitMode="fit",this.transform=null}setCanvasDimensions(e,t){this.canvasWidth=e,this.canvasHeight=t}setImageDimensions(e,t,s="fit"){this.imageWidth=e,this.imageHeight=t,this.fitMode=s,this.calculateImageBounds()}calculateImageBounds(){if(!this.imageWidth||!this.imageHeight||!this.canvasWidth||!this.canvasHeight){this.imageBounds=null,this.transform=null;return}let e=this.canvasWidth/this.canvasHeight,t=this.imageWidth/this.imageHeight,s,n,i,a,o;if(this.fitMode==="fit"?(t>e?s=this.canvasWidth/this.imageWidth:s=this.canvasHeight/this.imageHeight,a=this.imageWidth*s,o=this.imageHeight*s,n=(this.canvasWidth-a)/2,i=(this.canvasHeight-o)/2):(t>e?s=this.canvasHeight/this.imageHeight:s=this.canvasWidth/this.imageWidth,a=this.imageWidth*s,o=this.imageHeight*s,n=(this.canvasWidth-a)/2,i=(this.canvasHeight-o)/2),this.imageBounds={x:n,y:i,w:a,h:o,scale:s},this.fitMode==="fit")this.transform={c2i_scaleX:1/a,c2i_scaleY:1/o,c2i_offsetX:-n/a,c2i_offsetY:-i/o,i2c_scaleX:a,i2c_scaleY:o,i2c_offsetX:n,i2c_offsetY:i};else{let h=this.canvasWidth/s,r=this.canvasHeight/s,l=(this.imageWidth-h)/2,u=(this.imageHeight-r)/2;this.transform={c2i_scaleX:h/this.canvasWidth/this.imageWidth,c2i_scaleY:r/this.canvasHeight/this.imageHeight,c2i_offsetX:l/this.imageWidth,c2i_offsetY:u/this.imageHeight,i2c_scaleX:this.canvasWidth/h*this.imageWidth,i2c_scaleY:this.canvasHeight/r*this.imageHeight,i2c_offsetX:-l/h*this.canvasWidth,i2c_offsetY:-u/r*this.canvasHeight}}}canvasToImage(e,t){if(this.canvasWidth===this.imageWidth&&this.canvasHeight===this.imageHeight)return{x:e/this.canvasWidth,y:t/this.canvasHeight};if(!this.transform)return{x:this.canvasWidth>0?e/this.canvasWidth:0,y:this.canvasHeight>0?t/this.canvasHeight:0};let s=this.transform,n=e*s.c2i_scaleX+s.c2i_offsetX,i=t*s.c2i_scaleY+s.c2i_offsetY;return n=n<0?0:n>1?1:n,i=i<0?0:i>1?1:i,{x:n,y:i}}imageToCanvas(e,t){if(this.canvasWidth===this.imageWidth&&this.canvasHeight===this.imageHeight)return{x:e*this.canvasWidth,y:t*this.canvasHeight};if(!this.transform)return{x:e*this.canvasWidth,y:t*this.canvasHeight};let s=this.transform;return{x:e*s.i2c_scaleX+s.i2c_offsetX,y:t*s.i2c_scaleY+s.i2c_offsetY}}isWithinImageBounds(e,t){if(!this.imageBounds)return!1;let s=this.imageBounds;return e>=s.x&&e<=s.x+s.w&&t>=s.y&&t<=s.y+s.h}getImageBounds(){return this.imageBounds}getDisplayDimensions(){return this.imageBounds?{width:this.imageBounds.w,height:this.imageBounds.h}:{width:this.canvasWidth,height:this.canvasHeight}}reset(){this.canvasWidth=0,this.canvasHeight=0,this.imageWidth=0,this.imageHeight=0,this.imageBounds=null,this.transform=null,this.fitMode="fit"}};var R=class{constructor(){this._majorWaypointsCache=new Map,this._curvatureCache=new Map,this._useFastCurvature=!0}calculatePath(e,t={}){if(e.length<2)return[];let s=e.map(a=>({x:a.x||a.imgX,y:a.y||a.imgY,isMajor:a.isMajor})),n=_.createPath(s,t.pointsPerSegment||A.POINTS_PER_SEGMENT,t.tension||A.DEFAULT_TENSION),i=this.reparameterizeWithCornerSlowing(n,t.targetSpacing||A.TARGET_SPACING);return this.applyPathShapes(i,e)}reparameterizeWithCornerSlowing(e,t=A.TARGET_SPACING){if(e.length<2)return e;let s=this._getCachedCurvature(e),n=[0],i=0;for(let h=1;h<e.length;h++){let r=e[h].x-e[h-1].x,l=e[h].y-e[h-1].y,u=Math.sqrt(r*r+l*l),c=s[h],g=this._calculateVelocityFactor(c),y=u/g;i+=y,n.push(i)}let a=[],o=Math.floor(i/t);for(let h=0;h<=o;h++){let r=h/o*i,l=this._binarySearchSegment(n,r),u=n[l],g=(n[l+1]||u)-u,y=g>0?(r-u)/g:0,d=e[l],p=e[l+1]||d;a.push({x:d.x+(p.x-d.x)*y,y:d.y+(p.y-d.y)*y})}return a}_calculateVelocityFactor(e){let t=A.MAX_CURVATURE,s=A.MIN_CORNER_SPEED,n=Math.min(e/t,1),i=I.quadIn(n);return Math.max(s,1-i*(1-s))}_binarySearchSegment(e,t){let s=0,n=e.length-1;if(t<=e[0])return 0;if(t>=e[n])return n-1;for(;s<n-1;){let i=Math.floor((s+n)/2);e[i]<t?s=i:n=i}return s}applyPathShapes(e,t){let s=[],n=0;t.forEach(i=>{n+=(i.imgX||i.x||0)*1e3+(i.imgY||i.y||0)});for(let i=0;i<e.length;i++){let a=e[i],o=t.length-1,h=i/e.length,l=Math.min(Math.floor(h*o),o-1);for(;l>=0&&!t[l].isMajor;)l--;let u=l>=0?t[l]:null,c=(u==null?void 0:u.pathShape)||"line";if(c==="randomised"){let g=n+i*100,y=Math.sin(g)*1e4,d=Math.cos(g)*1e4,p=(y-Math.floor(y))*2-1,m=(d-Math.floor(d))*2-1;s.push({x:a.x+p*S.RANDOMISED_JITTER,y:a.y+m*S.RANDOMISED_JITTER,originalX:a.x,originalY:a.y,pathShape:c})}else s.push(W(w({},a),{pathShape:c}))}return s}getMajorWaypointPositions(e){let t=this._getCacheKey(e);if(this._majorWaypointsCache.has(t))return this._majorWaypointsCache.get(t);let s=[],n=e.length;return e.forEach((i,a)=>{if(i.isMajor){let o=n>1?a/(n-1):0;s.push({index:a,progress:o,waypoint:i})}}),this._majorWaypointsCache.set(t,s),s}findSegmentIndexForProgress(e,t){if(t<2)return-1;let s=t-1,n=e*s;return Math.min(Math.floor(n),s-1)}calculatePathLength(e){if(!e||e.length===0)return 0;let t=0;for(let s=1;s<e.length;s++){let n=e[s-1],i=e[s],a=i.x-n.x,o=i.y-n.y;t+=Math.sqrt(a*a+o*o)}return t}getPointAtProgress(e,t){if(e.length===0)return null;if(t<=0)return e[0];if(t>=1)return e[e.length-1];let s=Math.floor(t*(e.length-1)),n=t*(e.length-1)-s;if(s>=e.length-1)return e[e.length-1];let i=e[s],a=e[s+1];return{x:i.x+(a.x-i.x)*n,y:i.y+(a.y-i.y)*n}}clearCache(){this._majorWaypointsCache.clear(),this._curvatureCache.clear()}_getCachedCurvature(e){let t=this._getPathHash(e);if(!this._curvatureCache.has(t)){let s=this._useFastCurvature?this._calculateCurvatureFast(e):this._calculateCurvatureAccurate(e);this._curvatureCache.set(t,s)}return this._curvatureCache.get(t)}_calculateCurvatureFast(e){let t=[];for(let s=0;s<e.length;s++){if(s===0||s===e.length-1){t.push(0);continue}let n=e[s-1],i=e[s],a=e[s+1],o=Math.abs((i.x-n.x)*(a.y-n.y)-(a.x-n.x)*(i.y-n.y)),h=Math.hypot(i.x-n.x,i.y-n.y),r=Math.hypot(a.x-i.x,a.y-i.y),l=(h+r)/2;t.push(l>0?o/(l*l):0)}return t}_calculateCurvatureAccurate(e){let t=[];for(let s=0;s<e.length;s++){if(s===0||s===e.length-1){t.push(0);continue}let n=e[s-1],i=e[s],a=e[s+1],o=i.x-n.x,h=i.y-n.y,r=a.x-i.x,l=a.y-i.y,u=Math.sqrt(o*o+h*h),c=Math.sqrt(r*r+l*l);if(u===0||c===0){t.push(0);continue}let g=o/u,y=h/u,d=r/c,p=l/c,m=g*p-y*d,f=g*d+y*p,E=Math.atan2(m,f),T=(u+c)/2,v=T>0?Math.abs(E)/T:0;t.push(v)}return t}_getPathHash(e){let t=e.length;if(t<3)return"".concat(e[0].x,",").concat(e[0].y);let s=e[0],n=e[Math.floor(t/2)],i=e[t-1];return"".concat(s.x,",").concat(s.y,"|").concat(n.x,",").concat(n.y,"|").concat(i.x,",").concat(i.y,"|").concat(t)}_getCacheKey(e){return e.map(t=>"".concat(t.imgX,",").concat(t.imgY,",").concat(t.isMajor)).join("|")}};var se={},H=class extends R{constructor(){super(),this.worker=null,this.workerAvailable=!1,this.pendingRequests=new Map,this.requestId=0,this.initWorker()}initWorker(){if(typeof Worker<"u")try{this.worker=new Worker(new URL("../workers/pathWorker.js",se.url),{type:"module"}),this.worker.onmessage=this.handleWorkerMessage.bind(this),this.worker.onerror=this.handleWorkerError.bind(this),this.workerAvailable=!0,console.log("PathCalculator: Web Worker initialized")}catch(e){console.warn("PathCalculator: Failed to initialize Web Worker, falling back to main thread",e),this.workerAvailable=!1}else console.log("PathCalculator: Web Workers not supported, using main thread"),this.workerAvailable=!1}handleWorkerMessage(e){let{type:t,data:s,id:n,error:i}=e.data,a=this.pendingRequests.get(n);if(!a){console.warn("PathCalculator: Received message for unknown request",n);return}this.pendingRequests.delete(n),i?a.reject(new Error(i)):a.resolve(s.pathPoints)}handleWorkerError(e){console.error("PathCalculator: Worker error",e);for(let t of this.pendingRequests.values())t.reject(e);this.pendingRequests.clear(),this.workerAvailable=!1,this.worker=null}async calculatePathAsync(e){return this.workerAvailable?new Promise((t,s)=>{let n=this.requestId++;this.pendingRequests.set(n,{resolve:t,reject:s}),this.worker.postMessage({type:"calculate-path",data:{waypoints:e.map(i=>({x:i.x||i.imgX,y:i.y||i.imgY,isMajor:i.isMajor}))},id:n}),setTimeout(()=>{this.pendingRequests.has(n)&&(this.pendingRequests.delete(n),s(new Error("Path calculation timed out")))},5e3)}):Promise.resolve(this.calculatePath(e))}calculatePath(e){return this.workerAvailable&&!this.isSynchronousContext()&&console.warn("PathCalculator: Synchronous calculatePath called but worker is available. Consider using calculatePathAsync."),super.calculatePath(e)}isSynchronousContext(){return typeof requestAnimationFrame<"u"&&performance.now()%16.67<1}destroy(){if(this.worker){for(let e of this.pendingRequests.values())e.reject(new Error("PathCalculator destroyed"));this.pendingRequests.clear(),this.worker.terminate(),this.worker=null,this.workerAvailable=!1}}};var N=class{constructor(){this.reset()}reset(){let e=this.speed||C.DEFAULT_SPEED;console.log("\u{1F504} [AnimationState.reset()] BEFORE - speed:",this.speed,"preservedSpeed:",e),this.isPlaying=!1,this.progress=0,this.currentTime=0,this.duration=C.DEFAULT_DURATION,this.mode="constant-speed",this.speed=e,this.playbackSpeed=C.DEFAULT_PLAYBACK_SPEED,console.log("\u2705 [AnimationState.reset()] AFTER - speed:",this.speed,"duration:",this.duration),this.isPaused=!1,this.isWaitingAtWaypoint=!1,this.pauseWaypointIndex=-1,this.pauseStartTime=0,this.pauseEndTime=0,this.waypointProgressSnapshot=0,this.lastTime=0}play(){this.isPlaying=!0,this.isPaused=!1,this.lastTime=performance.now()}pause(){this.isPaused=!0}stop(){this.isPlaying=!1,this.isPaused=!1,this.progress=0,this.currentTime=0}togglePlayPause(){this.isPlaying&&!this.isPaused?this.pause():this.play()}setProgress(e){this.progress=Math.max(0,Math.min(1,e)),this.currentTime=this.progress*this.duration}setTime(e){this.currentTime=Math.max(0,Math.min(this.duration,e)),this.progress=this.duration>0?this.currentTime/this.duration:0}setMode(e){if(e==="constant-speed"||e==="constant-time")this.mode=e;else throw new Error("Invalid animation mode: ".concat(e))}startWaypointWait(e,t,s){this.isWaitingAtWaypoint=!0,this.pauseWaypointIndex=e,this.pauseStartTime=performance.now(),this.pauseEndTime=this.pauseStartTime+t,this.waypointProgressSnapshot=s}endWaypointWait(){this.isWaitingAtWaypoint=!1,this.pauseWaypointIndex=-1,this.waypointProgressSnapshot=0}isWaiting(){return this.isWaitingAtWaypoint}getEffectiveProgress(){return this.isWaitingAtWaypoint?this.waypointProgressSnapshot:this.progress}toJSON(){return{isPlaying:this.isPlaying,progress:this.progress,currentTime:this.currentTime,duration:this.duration,mode:this.mode,speed:this.speed,playbackSpeed:this.playbackSpeed,isPaused:this.isPaused,isWaitingAtWaypoint:this.isWaitingAtWaypoint,pauseWaypointIndex:this.pauseWaypointIndex}}fromJSON(e){Object.assign(this,e)}};var F=class{constructor(e=null){this.eventBus=e,this.state=new N,this.animationFrameId=null,this.lastFrameTime=0,this.onUpdate=null}start(e){this.animationFrameId&&this.stop(),this.onUpdate=e,this.state.play(),this.lastFrameTime=0;let t=s=>{this.animationFrameId=requestAnimationFrame(t);let n=s-this.lastFrameTime;if(n>C.FRAME_INTERVAL){if(this.lastFrameTime=s-n%C.FRAME_INTERVAL,this.state.isPlaying&&!this.state.isPaused){let i=Math.min(n,C.MAX_DELTA_TIME)*this.state.playbackSpeed;this.updateAnimation(i,s)}this.onUpdate&&this.onUpdate(this.state),this.emit("update",this.state)}};requestAnimationFrame(t)}updateAnimation(e,t){if(this.state.isWaitingAtWaypoint)if(t>=this.state.pauseEndTime)this.state.endWaypointWait(),this.emit("waypointWaitEnd",this.state.pauseWaypointIndex);else return;this.state.currentTime+=e,this.state.currentTime>=this.state.duration?(this.state.currentTime=this.state.duration,this.state.progress=1,this.pause(),this.emit("complete")):(this.state.progress=this.state.currentTime/this.state.duration,this.waypointCheckCallback&&this.waypointCheckCallback(this.state.progress))}pause(){this.state.pause(),this.emit("pause")}play(){this.state.play(),this.emit("play")}togglePlayPause(){this.state.isPlaying&&!this.state.isPaused?this.pause():this.play()}stop(){this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.state.stop(),this.emit("stop")}reset(){this.state.reset(),this.emit("reset")}seekToTime(e){this.state.setTime(e),this.emit("seek",e)}seekToProgress(e){this.state.setProgress(e),this.emit("seek",e*this.state.duration)}setDuration(e){let t=this.state.progress;console.log("\u23F1\uFE0F  [AnimationEngine.setDuration()] duration:",e,"ms (",(e/1e3).toFixed(1),"s), progress:",t),this.state.duration=e,this.state.setProgress(t),this.emit("durationChange",e)}setSpeed(e){let s=Math.round(e/5)*5;console.log("\u{1F3C3} [AnimationEngine.setSpeed()] speed:",s,"px/s (was:",this.state.speed,", raw:",e,")"),this.state.speed=s,this.emit("speedChange",s)}setPlaybackSpeed(e){this.state.playbackSpeed=Math.max(.1,Math.min(10,e)),this.emit("playbackSpeedChange",this.state.playbackSpeed)}setMode(e){this.state.setMode(e),this.emit("modeChange",e)}startWaypointWait(e,t){let s=this.state.progress;this.state.startWaypointWait(e,t,s),this.emit("waypointWaitStart",{index:e,duration:t})}setWaypointCheckCallback(e){this.waypointCheckCallback=e}isPlaying(){return this.state.isPlaying&&!this.state.isPaused}isComplete(){return this.state.progress>=1}getState(){return this.state}getProgress(){return this.state.getEffectiveProgress()}getTime(){return this.state.currentTime}calculateDurationFromSpeed(e){return this.state.mode==="constant-speed"&&this.state.speed>0?e/this.state.speed*1e3:this.state.duration}emit(e,t){this.eventBus&&this.eventBus.emit("animation:".concat(e),t)}destroy(){this.stop(),this.onUpdate=null,this.waypointCheckCallback=null,this.eventBus=null}};var U=class{constructor(){this.vectorCanvas=null,this.waypointPositions=[]}render(e,t,s,n){let i=t||e.canvas.width,a=s||e.canvas.height;if(i<=0||a<=0){console.warn("Cannot render to canvas with invalid dimensions:",{width:i,height:a});return}e.clearRect(0,0,i,a),this.renderBackground(e,n.background,i,a),this.renderOverlay(e,n.background.overlay,i,a);let o=this.getVectorCanvas(t,s);if(o.width<=0||o.height<=0){console.warn("Vector canvas has invalid dimensions:",{width:o.width,height:o.height});return}let h=o.getContext("2d");h.clearRect(0,0,o.width,o.height),this.renderVectorLayerTo(h,n),o.width>0&&o.height>0&&e.drawImage(o,0,0)}getVectorCanvas(e,t){this.vectorCanvas||(this.vectorCanvas=document.createElement("canvas"));let s=e||100,n=t||100,i=Math.max(1,s),a=Math.max(1,n);if(this.vectorCanvas.width!==i||this.vectorCanvas.height!==a){console.log("Resizing vector canvas to:",i,"x",a),this.vectorCanvas.width=i,this.vectorCanvas.height=a;let o=this.vectorCanvas.getContext("2d");o&&(o.imageSmoothingEnabled=!1)}return this.vectorCanvas}renderBackground(e,t,s,n){if(!t.image)return;let i=t.image,a=i.naturalWidth||i.width,o=i.naturalHeight||i.height,h=s,r=n;if(t.fit==="fit"){let l=Math.min(h/a,r/o),u=Math.round(a*l),c=Math.round(o*l),g=Math.floor((h-u)/2),y=Math.floor((r-c)/2);e.drawImage(i,0,0,a,o,g,y,u,c)}else{let l=Math.max(h/a,r/o),u=h/l,c=r/l,g=(a-u)/2,y=(o-c)/2;e.drawImage(i,g,y,u,c,0,0,h,r)}}renderOverlay(e,t,s,n){t!==0&&(e.save(),e.globalAlpha=Math.min(Math.abs(t)/100,.6),e.fillStyle=t<0?"#000":"#fff",e.fillRect(0,0,s,n),e.restore())}renderVectorLayerTo(e,t){let{waypoints:s,pathPoints:n,styles:i,animationEngine:a,selectedWaypoint:o,imageToCanvas:h,displayWidth:r,displayHeight:l}=t;n.length>0&&s.length>1&&(this.renderPath(e,n,s,i,a),this.renderPathHead(e,n,i,a)),this.renderBeacons(e,s,a,t.beaconAnimation,h,i),this.renderWaypoints(e,s,o,i,h,r,l)}renderPath(e,t,s,n,i){let a=t.length,o=i.getProgress(),h=a*o,r=Math.floor(h),l=h-r,u=s.length-1,c=Math.floor(a/u),g=new Array(u);this.waypointPositions=[],s.forEach((d,p)=>{if(p<s.length-1){let m=p/u*a;this.waypointPositions.push({waypointIndex:p,pointIndex:m})}});let y=-1;for(let d=0;d<u;d++)s[d].isMajor&&(y=d),g[d]=y;for(let d=1;d<r;d++){let p=Math.min(Math.floor(d/c),u-1),m=g[p],f=m>=0?s[m]:{segmentColor:n.pathColor,segmentWidth:n.pathThickness,segmentStyle:"solid",pathShape:"line"};e.strokeStyle=f.segmentColor,e.lineWidth=f.segmentWidth,e.lineCap="round",e.lineJoin="round",this.applyLineStyle(e,f.segmentStyle),e.beginPath();let E=f.pathShape||"line",T=t[d-1],v=t[d];if(E==="squiggle"){let x=(T.x+v.x)/2,M=(T.y+v.y)/2,k=-(v.y-T.y)*.15,z=(v.x-T.x)*.15;e.moveTo(T.x,T.y);let L=Math.sin(d*.5)*.5;e.quadraticCurveTo(x+k*L,M+z*L,v.x,v.y)}else if(E==="randomised"){let M={x:T.x+(Math.random()-.5)*3,y:T.y+(Math.random()-.5)*3},k={x:v.x+(Math.random()-.5)*3,y:v.y+(Math.random()-.5)*3};e.moveTo(M.x,M.y),e.lineTo(k.x,k.y)}else e.moveTo(T.x,T.y),e.lineTo(v.x,v.y);e.stroke()}if(r>0&&r<a&&l>1e-5){Math.random()<.01&&console.log("[RenderPath] Drawing partial segment - fraction:",l.toFixed(5),"at point:",r);let d=r,p=Math.min(Math.floor(d/c),u-1),m=g[p],f=m>=0?s[m]:{segmentColor:n.pathColor,segmentWidth:n.pathThickness,segmentStyle:"solid",pathShape:"line"};e.strokeStyle=f.segmentColor,e.lineWidth=f.segmentWidth,e.lineCap="round",e.lineJoin="round",this.applyLineStyle(e,f.segmentStyle),e.beginPath();let E=t[d-1],T=t[d],v={x:E.x+(T.x-E.x)*l,y:E.y+(T.y-E.y)*l},x=f.pathShape||"line";if(x==="squiggle"){let M=(E.x+v.x)/2,k=(E.y+v.y)/2,z=-(v.y-E.y)*.15,L=(v.x-E.x)*.15;e.moveTo(E.x,E.y);let q=Math.sin(d*.5)*.5;e.quadraticCurveTo(M+z*q,k+L*q,v.x,v.y)}else e.moveTo(E.x,E.y),e.lineTo(v.x,v.y);e.stroke()}e.setLineDash([])}renderPathHead(e,t,s,n){let i=n.getProgress(),a=t.length,o=a*i,h=Math.floor(o);if(h>1&&h<a){let r=Math.min(h-1,t.length-2),l=r+1,u=o-h,c=t[r],g=t[l],y={x:c.x+(g.x-c.x)*u,y:c.y+(g.y-c.y)*u},d=0;if(r>0){let p=t[r-1];d=Math.atan2(g.y-p.y,g.x-p.x)}s.pathHead.rotation=d,this.drawPathHead(e,y.x,y.y,d,s.pathHead)}else if(h>=a&&a>0){let r=t[a-1],l=a>1?t[a-2]:r,u=Math.atan2(r.y-l.y,r.x-l.x);s.pathHead.rotation=u,this.drawPathHead(e,r.x,r.y,u,s.pathHead)}}drawPathHead(e,t,s,n,i){if(!isFinite(t)||!isFinite(s)){console.warn("Invalid path head coordinates:",{x:t,y:s});return}let a=i.size;switch(e.save(),e.translate(t,s),e.rotate(n),i.style){case"dot":e.beginPath(),e.fillStyle=i.color,e.arc(0,0,a/2,0,Math.PI*2),e.fill();break;case"arrow":e.beginPath(),e.fillStyle=i.color,e.moveTo(a,0),e.lineTo(-a/2,a/2),e.lineTo(-a/4,0),e.lineTo(-a/2,-a/2),e.closePath(),e.fill();break;case"custom":if(i.image){let o=a*2;e.drawImage(i.image,-o/2,-o/2,o,o)}else e.beginPath(),e.fillStyle=i.color,e.arc(0,0,a/2,0,Math.PI*2),e.fill();break;default:e.beginPath(),e.fillStyle=i.color,e.arc(0,0,a/2,0,Math.PI*2),e.fill()}e.restore()}renderBeacons(e,t,s,n,i,a){if(!t.length)return;let o=s.getProgress();t.forEach((h,r)=>{if(h.isMajor){let l=r/(t.length-1),u=Math.abs(o-l)<.001,c=s.state.isPaused&&s.state.pauseWaypointIndex===r;if(u||c){let g=i(h.imgX,h.imgY);this.drawBeacon(e,W(w({},h),{x:g.x,y:g.y}),n,a)}}})}drawBeacon(e,t,s,n){let i=t.beaconStyle||"none",a=t.beaconColor||n.beaconColor;if(i!=="none"){if(!isFinite(t.x)||!isFinite(t.y)){console.warn("Invalid beacon coordinates:",t);return}if(i==="pulse"){s.pulsePhase=performance.now()*.003;let o=1+Math.sin(s.pulsePhase)*.3,h=S.BEACON_PULSE_SIZE*o;e.beginPath(),e.arc(t.x,t.y,h,0,Math.PI*2),e.fillStyle=a,e.globalAlpha=S.BEACON_PULSE_OPACITY,e.fill(),s.pulsePhase=(s.pulsePhase+.1)%(Math.PI*2)}else if(i==="ripple"){let o=Date.now();(!t.lastRipple||o-t.lastRipple>S.BEACON_RIPPLE_INTERVAL)&&(s.ripples.push({x:t.x,y:t.y,radius:0,opacity:.5,startTime:o,color:a}),t.lastRipple=o),s.ripples=s.ripples.filter(h=>{let r=o-h.startTime;if(r>S.BEACON_RIPPLE_DURATION)return!1;let l=r/S.BEACON_RIPPLE_SPEED,u=r/S.BEACON_RIPPLE_DURATION,c=.5*(1-I.cubicOut(u));return e.beginPath(),e.arc(h.x,h.y,l,0,Math.PI*2),e.strokeStyle=h.color,e.lineWidth=2,e.globalAlpha=c,e.stroke(),!0}),e.beginPath(),e.fillStyle=a,e.globalAlpha=.8,e.arc(t.x,t.y,6,0,Math.PI*2),e.fill()}e.globalAlpha=1}}renderWaypoints(e,t,s,n,i,a,o){t.forEach(h=>{if(h.isMajor){let r=i(h.imgX,h.imgY),l=h===s,u=h.dotSize||n.dotSize,c=l?u*1.3:u,g=h.markerStyle||n.markerStyle;if(g==="none"){this.renderLabel(e,h,r.x,r.y,0,t,n.animationEngine,a,o);return}e.fillStyle=h.dotColor||h.segmentColor||n.dotColor,e.strokeStyle=l?"#4a90e2":"white",e.lineWidth=l?3:2,g==="square"?(e.beginPath(),e.rect(r.x-c,r.y-c,c*2,c*2),e.fill(),e.stroke()):g==="flag"?(e.beginPath(),e.moveTo(r.x,r.y-c*2),e.lineTo(r.x,r.y+c),e.moveTo(r.x,r.y-c*2),e.lineTo(r.x+c*1.5,r.y-c*1.3),e.lineTo(r.x+c*1.2,r.y-c),e.lineTo(r.x,r.y-c*.7),e.closePath(),e.fill(),e.stroke()):(e.beginPath(),e.arc(r.x,r.y,c,0,Math.PI*2),e.fill(),e.stroke()),this.renderLabel(e,h,r.x,r.y,c,t,n.animationEngine,a,o)}})}renderLabel(e,t,s,n,i,a,o,h,r){if(!t.label||t.labelMode==="none")return;let l=a.indexOf(t),u=this.waypointPositions.length,c=0;l<a.length-1?c=l/(a.length-1)*u:c=u;let g=u*o.getProgress(),y=u*.02,d=0;switch(t.labelMode){case"on":d=1;break;case"fade":if(g<c)return;let v=g-c;if(v<=y/2)d=Math.min(1,v/(y/2)),d=Math.pow(d,.5);else if(v<=y*3)d=1;else if(v<=y*4)d=1-Math.min(1,(v-y*3)/y);else return;break;case"persist":let x=c-g;if(x>y)return;if(x>0){let M=1-x/y;d=Math.pow(M,.5)}else d=1;break;default:return}e.save(),e.globalAlpha=Math.max(.15,d),e.font="bold 16px Arial";let p=d<1?Math.max(0,1-d)*60:0;e.fillStyle="rgb(".concat(255-p,", ").concat(255-p,", 255)"),e.strokeStyle="#000",e.lineWidth=3,e.textAlign="center",e.textBaseline="middle",e.shadowColor="rgba(0, 0, 0, 0.7)",e.shadowBlur=5,e.shadowOffsetX=2,e.shadowOffsetY=2;let m=S.LABEL_OFFSET_X,f=t.labelPosition||"auto",E=s,T=n;switch(f){case"top":T=n-i-m;break;case"right":E=s+i+m,e.textAlign="left";break;case"bottom":T=n+i+m;break;case"left":E=s-i-m,e.textAlign="right";break;case"auto":default:let v=h,x=r;T=n-i-m,T<30&&(T=n+i+m),s<100?(E=s+i+m,e.textAlign="left"):s>v-100&&(E=s-i-m,e.textAlign="right");break}e.strokeText(t.label,E,T),e.fillText(t.label,E,T),e.restore()}applyLineStyle(e,t){switch(t){case"dotted":e.setLineDash([2,6]);break;case"dashed":e.setLineDash([10,5]);break;case"squiggle":e.setLineDash([5,3,2,3]);break;case"solid":default:e.setLineDash([]);break}}};var Y=class{constructor(){this.events=new Map}on(e,t){return this.events.has(e)||this.events.set(e,[]),this.events.get(e).push(t),()=>this.off(e,t)}subscribe(e,t){return this.on(e,t)}off(e,t){if(!this.events.has(e))return;let s=this.events.get(e),n=s.indexOf(t);n>-1&&s.splice(n,1),s.length===0&&this.events.delete(e)}unsubscribe(e,t){this.off(e,t)}once(e,t){let s=(...n)=>{t(...n),this.off(e,s)};return this.on(e,s)}emit(e,...t){if(!this.events.has(e))return;[...this.events.get(e)].forEach(i=>{try{i(...t)}catch(a){console.error("Error in event listener for ".concat(e,":"),a)}})}publish(e,...t){this.emit(e,...t)}async emitAsync(e,...t){if(!this.events.has(e))return;let i=[...this.events.get(e)].map(a=>Promise.resolve().then(()=>a(...t)));await Promise.all(i)}removeAllListeners(e){e?this.events.delete(e):this.events.clear()}listenerCount(e){return this.events.has(e)?this.events.get(e).length:0}eventNames(){return Array.from(this.events.keys())}clear(){this.events.clear()}destroy(){this.clear()}};var B=class b{constructor(e={}){this.imgX=e.imgX||0,this.imgY=e.imgY||0,this.isMajor=e.isMajor!==void 0?e.isMajor:!0,this._dirtyProps=new Set,this.segmentColor=e.segmentColor||S.DEFAULT_PATH_COLOR,this.segmentWidth=e.segmentWidth||S.DEFAULT_PATH_THICKNESS,this.segmentStyle=e.segmentStyle||"solid",this.segmentTension=e.segmentTension||.5,this.pathShape=e.pathShape||"line",this.markerStyle=e.markerStyle||"dot",this.dotColor=e.dotColor||S.DEFAULT_PATH_COLOR,this.dotSize=e.dotSize||(this.isMajor?S.DEFAULT_DOT_SIZE:S.MINOR_DOT_SIZE),this.beaconStyle=e.beaconStyle||"none",this.beaconColor=e.beaconColor||S.DEFAULT_PATH_COLOR,this.label=e.label||"",this.labelMode=e.labelMode||"none",this.labelPosition=e.labelPosition||"auto",this.pauseMode=e.pauseMode||"none",this.pauseTime=e.pauseTime||C.DEFAULT_WAIT_TIME,this.pathHeadStyle=e.pathHeadStyle||"arrow",this.pathHeadColor=e.pathHeadColor||"#111111",this.pathHeadSize=e.pathHeadSize||S.PATH_HEAD_SIZE,this.pathHeadImage=e.pathHeadImage||null,this.customImage=e.customImage||null,this.id=e.id||this.generateId(),this.created=e.created||Date.now(),this.modified=Date.now()}generateId(){return"wp_".concat(Date.now(),"_").concat(Math.random().toString(36).substr(2,9))}update(e){Object.keys(e).forEach(t=>{t in this&&t!=="id"&&t!=="created"&&this[t]!==e[t]&&(this[t]=e[t],this._dirtyProps.add(t))}),this.modified=Date.now()}setPosition(e,t){this.imgX=Math.max(0,Math.min(1,e)),this.imgY=Math.max(0,Math.min(1,t)),this.modified=Date.now()}toggleType(){this.isMajor=!this.isMajor,this.isMajor?this.dotSize=S.DEFAULT_DOT_SIZE:(this.labelMode="none",this.beaconStyle="none",this.pauseMode="none",this.dotSize=S.MINOR_DOT_SIZE),this.modified=Date.now()}shouldPause(){return this.isMajor&&this.pauseMode==="timed"&&this.pauseTime>0}getPauseDuration(){return this.shouldPause()?this.pauseTime:0}hasLabel(){return this.label&&this.label.trim().length>0&&this.labelMode!=="none"}hasBeacon(){return this.beaconStyle!=="none"}isVisible(){return this.markerStyle!=="none"}copyPropertiesFrom(e,t=["id","imgX","imgY","created","modified","label"]){return["segmentColor","segmentWidth","segmentStyle","segmentTension","pathShape","markerStyle","dotColor","dotSize","beaconStyle","beaconColor","labelMode","labelPosition","pauseMode","pauseTime","pathHeadStyle","pathHeadColor","pathHeadSize","pathHeadImage","customImage"].forEach(n=>{!t.includes(n)&&n in e&&(this[n]=e[n])}),!this.isMajor&&e.isMajor&&(this.labelMode="none",this.beaconStyle="none",this.pauseMode="none"),this.modified=Date.now(),this}getDirtyProps(){return Array.from(this._dirtyProps)}clearDirtyProps(){this._dirtyProps.clear()}isStyleChange(){let e=["dotColor","dotSize","markerStyle","beaconColor","beaconStyle","label","labelMode","labelPosition"];return this._dirtyProps.size>0&&Array.from(this._dirtyProps).every(t=>e.includes(t))}isPathChange(){let e=["segmentColor","segmentWidth","segmentStyle","pathShape","segmentTension"];return Array.from(this._dirtyProps).some(t=>e.includes(t))}isPositionChange(){return this._dirtyProps.has("imgX")||this._dirtyProps.has("imgY")}clone(){return new b(this.toJSON())}toJSON(){return{id:this.id,imgX:this.imgX,imgY:this.imgY,isMajor:this.isMajor,segmentColor:this.segmentColor,segmentWidth:this.segmentWidth,segmentStyle:this.segmentStyle,segmentTension:this.segmentTension,pathShape:this.pathShape,markerStyle:this.markerStyle,dotColor:this.dotColor,dotSize:this.dotSize,beaconStyle:this.beaconStyle,beaconColor:this.beaconColor,label:this.label,labelMode:this.labelMode,labelPosition:this.labelPosition,pauseMode:this.pauseMode,pauseTime:this.pauseTime,pathHeadStyle:this.pathHeadStyle,pathHeadColor:this.pathHeadColor,pathHeadSize:this.pathHeadSize,pathHeadImage:this.pathHeadImage,customImage:this.customImage,created:this.created,modified:this.modified}}static fromJSON(e){return new b(e)}static createMajor(e,t){return new b({imgX:e,imgY:t,isMajor:!0})}static createMinor(e,t){return new b({imgX:e,imgY:t,isMajor:!1,labelMode:"none",beaconStyle:"none",pauseMode:"none",dotSize:S.MINOR_DOT_SIZE})}static validate(e){return!(!e||typeof e!="object"||typeof e.imgX!="number"||e.imgX<0||e.imgX>1||typeof e.imgY!="number"||e.imgY<0||e.imgY>1||e.markerStyle&&!["dot","square","flag","none"].includes(e.markerStyle)||e.segmentStyle&&!["solid","dashed","dotted"].includes(e.segmentStyle)||e.pathShape&&!["line","squiggle","randomised"].includes(e.pathShape)||e.beaconStyle&&!["none","pulse","ripple"].includes(e.beaconStyle)||e.labelMode&&!["none","on","fade","persist"].includes(e.labelMode)||e.pauseMode&&!["none","timed"].includes(e.pauseMode))}};var j=class{constructor(e,t){this.elements=e,this.eventBus=t,this.selectedWaypoint=null,this.updateWaypointList=this.updateWaypointList.bind(this),this.updateWaypointEditor=this.updateWaypointEditor.bind(this),this.syncAnimationControls=this.syncAnimationControls.bind(this),this.setupEventListeners()}setupEventListeners(){var t,s,n,i,a,o,h,r,l,u,c,g,y;console.log("\u{1F527} [UIController] Setting up event listeners at:",performance.now().toFixed(2),"ms"),(t=this.elements.tabBtns)==null||t.forEach(d=>{d.addEventListener("click",p=>this.handleTabSwitch(p))}),(s=this.elements.bgUploadBtn)==null||s.addEventListener("click",()=>{this.elements.bgUpload.click()}),(n=this.elements.bgUpload)==null||n.addEventListener("change",d=>{let p=d.target.files[0];p&&this.eventBus.emit("background:upload",p)}),(i=this.elements.bgOverlay)==null||i.addEventListener("input",d=>{let p=parseInt(d.target.value);this.elements.bgOverlayValue.textContent=p,this.eventBus.emit("background:overlay-change",p)}),(a=this.elements.bgFitToggle)==null||a.addEventListener("click",()=>{let p=this.elements.bgFitToggle.dataset.mode==="fit"?"fill":"fit";this.elements.bgFitToggle.dataset.mode=p,this.elements.bgFitToggle.textContent=p==="fit"?"Fit":"Fill",this.eventBus.emit("background:mode-change",p)}),(o=this.elements.playBtn)==null||o.addEventListener("click",()=>{this.eventBus.emit("ui:animation:play")}),(h=this.elements.pauseBtn)==null||h.addEventListener("click",()=>{this.eventBus.emit("ui:animation:pause")}),(r=this.elements.skipStartBtn)==null||r.addEventListener("click",()=>{this.eventBus.emit("ui:animation:skip-start")}),(l=this.elements.skipEndBtn)==null||l.addEventListener("click",()=>{this.eventBus.emit("ui:animation:skip-end")}),(u=this.elements.timelineSlider)==null||u.addEventListener("input",d=>{let p=d.target.value/C.TIMELINE_RESOLUTION;this.eventBus.emit("ui:animation:seek",p)});let e=!1;(c=this.elements.animationSpeed)==null||c.addEventListener("input",d=>{let p=parseInt(d.target.value),m=performance.now().toFixed(2);if(console.log("\n\u{1F4E1} [".concat(m,"ms] SLIDER INPUT EVENT:"),{value:p,isTrusted:d.isTrusted,isUpdating:e,hasFocus:document.activeElement===d.target,eventType:d.type,target:d.target.id}),e){console.log("\u{1F6E1}\uFE0F [UIController] Blocked programmatic input event, value:",p),console.trace("Blocked event stack trace");return}let f=p;console.log("\u{1F39A}\uFE0F [UIController] User moved slider to:",f),console.trace("User input stack trace"),this.eventBus.emit("animation:speed-change",f)}),this.eventBus.on("ui:slider:update-speed",d=>{let p=performance.now().toFixed(2),m=5,f=Math.round(d/m)*m;console.log("\n\u{1F4B5} [".concat(p,"ms] PROGRAMMATIC UPDATE:"),{requested:d,rounded:f,currentSliderValue:this.elements.animationSpeed.value}),console.trace("Update origin"),e=!0,this.elements.animationSpeed.value=f,console.log("\u2705 [".concat(performance.now().toFixed(2),"ms] Protection ENABLED")),setTimeout(()=>{let E=performance.now().toFixed(2);console.log("\u2705 [".concat(E,"ms] Re-enabling slider input detection")),e=!1},50)}),(g=this.elements.clearBtn)==null||g.addEventListener("click",()=>{confirm("Clear all waypoints?")&&this.eventBus.emit("waypoints:clear-all")}),(y=this.elements.helpBtn)==null||y.addEventListener("click",()=>{this.showHelp()}),this.setupWaypointEditorControls()}setupWaypointEditorControls(){var e,t,s,n,i,a,o,h,r,l,u,c,g,y,d,p;(e=this.elements.markerStyle)==null||e.addEventListener("change",m=>{this.selectedWaypoint&&this.eventBus.emit("waypoint:style-changed",{waypoint:this.selectedWaypoint,property:"markerStyle",value:m.target.value})}),(t=this.elements.dotColor)==null||t.addEventListener("input",m=>{this.selectedWaypoint&&this.eventBus.emit("waypoint:style-changed",{waypoint:this.selectedWaypoint,property:"dotColor",value:m.target.value})}),(s=this.elements.dotSize)==null||s.addEventListener("input",m=>{let f=parseInt(m.target.value);this.elements.dotSizeValue.textContent=f,this.selectedWaypoint&&this.eventBus.emit("waypoint:style-changed",{waypoint:this.selectedWaypoint,property:"dotSize",value:f})}),(n=this.elements.segmentColor)==null||n.addEventListener("input",m=>{this.selectedWaypoint&&this.eventBus.emit("waypoint:path-property-changed",{waypoint:this.selectedWaypoint,property:"segmentColor",value:m.target.value})}),(i=this.elements.segmentWidth)==null||i.addEventListener("input",m=>{let f=parseInt(m.target.value);this.elements.segmentWidthValue.textContent=f,this.selectedWaypoint&&this.eventBus.emit("waypoint:path-property-changed",{waypoint:this.selectedWaypoint,property:"segmentWidth",value:f})}),(a=this.elements.segmentStyle)==null||a.addEventListener("change",m=>{this.selectedWaypoint&&this.eventBus.emit("waypoint:path-property-changed",{waypoint:this.selectedWaypoint,property:"segmentStyle",value:m.target.value})}),(o=this.elements.pathShape)==null||o.addEventListener("change",m=>{this.selectedWaypoint&&this.eventBus.emit("waypoint:path-property-changed",{waypoint:this.selectedWaypoint,property:"pathShape",value:m.target.value})}),(h=this.elements.editorBeaconStyle)==null||h.addEventListener("change",m=>{this.selectedWaypoint&&this.eventBus.emit("waypoint:style-changed",{waypoint:this.selectedWaypoint,property:"beaconStyle",value:m.target.value})}),(r=this.elements.editorBeaconColor)==null||r.addEventListener("input",m=>{this.selectedWaypoint&&this.eventBus.emit("waypoint:style-changed",{waypoint:this.selectedWaypoint,property:"beaconColor",value:m.target.value})}),(l=this.elements.waypointLabel)==null||l.addEventListener("input",m=>{this.selectedWaypoint&&this.eventBus.emit("waypoint:style-changed",{waypoint:this.selectedWaypoint,property:"label",value:m.target.value})}),(u=this.elements.labelMode)==null||u.addEventListener("change",m=>{this.selectedWaypoint&&this.eventBus.emit("waypoint:style-changed",{waypoint:this.selectedWaypoint,property:"labelMode",value:m.target.value})}),(c=this.elements.labelPosition)==null||c.addEventListener("change",m=>{this.selectedWaypoint&&this.eventBus.emit("waypoint:style-changed",{waypoint:this.selectedWaypoint,property:"labelPosition",value:m.target.value})}),(g=this.elements.waypointPauseTime)==null||g.addEventListener("input",m=>{let f=parseFloat(m.target.value);this.elements.waypointPauseTimeValue.textContent="".concat(f,"s"),this.selectedWaypoint&&this.eventBus.emit("waypoint:style-changed",{waypoint:this.selectedWaypoint,property:"pauseTime",value:f*1e3})}),(y=this.elements.pathHeadStyle)==null||y.addEventListener("change",m=>{this.eventBus.emit("pathhead:style-changed",m.target.value)}),(d=this.elements.pathHeadColor)==null||d.addEventListener("input",m=>{this.eventBus.emit("pathhead:color-changed",m.target.value)}),(p=this.elements.pathHeadSize)==null||p.addEventListener("input",m=>{let f=parseInt(m.target.value);this.elements.pathHeadSizeValue.textContent=f,this.eventBus.emit("pathhead:size-changed",f)})}handleTabSwitch(e){let t=e.target,s=t.dataset.tab;this.elements.tabBtns.forEach(i=>i.classList.remove("active")),t.classList.add("active"),document.querySelectorAll(".tab-content").forEach(i=>{i.classList.remove("active")});let n=document.getElementById("".concat(s,"-tab"));n&&n.classList.add("active")}updateWaypointList(e){if(!this.elements.waypointList)return;this.elements.waypointList.innerHTML="";let t=e.filter(s=>s.isMajor);t.forEach((s,n)=>{let i=document.createElement("div");i.className="waypoint-item",i.draggable=!0,s===this.selectedWaypoint&&i.classList.add("selected");let a=document.createElement("span");a.className="waypoint-item-handle",a.textContent="\u2630";let o=document.createElement("span");o.className="waypoint-item-label",o.textContent=s.label||"Waypoint ".concat(n+1);let h=document.createElement("button");h.className="waypoint-item-delete",h.textContent="\xD7",h.title="Delete waypoint",i.appendChild(a),i.appendChild(o),i.appendChild(h);let r=l=>{l.stopPropagation(),this.eventBus.emit("waypoint:selected",s)};o.addEventListener("click",r),a.addEventListener("click",r),i.addEventListener("click",r),h.addEventListener("click",l=>{l.stopPropagation(),confirm("Delete this waypoint?")&&this.eventBus.emit("waypoint:deleted",s)}),i.addEventListener("dragstart",l=>{l.dataTransfer.effectAllowed="move",l.dataTransfer.setData("text/plain",n.toString()),i.classList.add("dragging")}),i.addEventListener("dragend",l=>{i.classList.remove("dragging")}),i.addEventListener("dragover",l=>{l.preventDefault(),l.dataTransfer.dropEffect="move";let u=this.elements.waypointList.querySelector(".dragging");if(u&&u!==i){let c=i.getBoundingClientRect(),g=c.top+c.height/2;l.clientY<g?i.parentNode.insertBefore(u,i):i.parentNode.insertBefore(u,i.nextSibling)}}),i.addEventListener("drop",l=>{l.preventDefault();let c=Array.from(this.elements.waypointList.children).map(g=>{let y=Array.from(g.parentElement.children).indexOf(g);return t[parseInt(g.dataset.originalIndex||y)]});this.eventBus.emit("waypoints:reordered",c)}),i.dataset.originalIndex=n,this.elements.waypointList.appendChild(i)})}updateWaypointEditor(e){if(this.selectedWaypoint=e,!e){this.elements.waypointEditor&&(this.elements.waypointEditor.style.display="none"),this.elements.waypointEditorPlaceholder&&(this.elements.waypointEditorPlaceholder.style.display="flex");return}if(this.elements.waypointEditor&&(this.elements.waypointEditor.style.display="block"),this.elements.waypointEditorPlaceholder&&(this.elements.waypointEditorPlaceholder.style.display="none"),this.elements.markerStyle&&(this.elements.markerStyle.value=e.markerStyle||"dot"),this.elements.dotColor&&(this.elements.dotColor.value=e.dotColor||"#FF6B6B"),this.elements.dotSize&&(this.elements.dotSize.value=e.dotSize||8,this.elements.dotSizeValue.textContent=e.dotSize||8),this.elements.segmentColor&&(this.elements.segmentColor.value=e.segmentColor||"#FF6B6B"),this.elements.segmentWidth&&(this.elements.segmentWidth.value=e.segmentWidth||3,this.elements.segmentWidthValue.textContent=e.segmentWidth||3),this.elements.segmentStyle&&(this.elements.segmentStyle.value=e.segmentStyle||"solid"),this.elements.pathShape&&(this.elements.pathShape.value=e.pathShape||"line"),this.elements.editorBeaconStyle&&(this.elements.editorBeaconStyle.value=e.beaconStyle||"pulse"),this.elements.editorBeaconColor&&(this.elements.editorBeaconColor.value=e.beaconColor||"#FF6B6B"),this.elements.waypointLabel&&(this.elements.waypointLabel.value=e.label||""),this.elements.labelMode&&(this.elements.labelMode.value=e.labelMode||"none"),this.elements.labelPosition&&(this.elements.labelPosition.value=e.labelPosition||"auto"),this.elements.waypointPauseTime){let s=(e.pauseTime||1500)/1e3;this.elements.waypointPauseTime.value=s,this.elements.waypointPauseTimeValue.textContent="".concat(s,"s")}let t=this.elements.pauseTimeControl;t&&(t.style.display=e.isMajor?"block":"none")}syncAnimationControls(e){e.isPlaying?(this.elements.playBtn&&(this.elements.playBtn.style.display="none"),this.elements.pauseBtn&&(this.elements.pauseBtn.style.display="inline-block")):(this.elements.playBtn&&(this.elements.playBtn.style.display="inline-block"),this.elements.pauseBtn&&(this.elements.pauseBtn.style.display="none")),this.elements.timelineSlider&&!e.isDraggingTimeline&&(this.elements.timelineSlider.value=Math.round(e.progress*C.TIMELINE_RESOLUTION)),this.updateTimeDisplay(e.currentTime,e.duration)}updateTimeDisplay(e,t){let s=n=>{let i=Math.floor(n/1e3),a=Math.floor(i/60),o=i%60;return"".concat(a,":").concat(o.toString().padStart(2,"0"))};this.elements.currentTime&&(this.elements.currentTime.textContent=s(e)),this.elements.totalTime&&(this.elements.totalTime.textContent=s(t))}showHelp(){this.elements.splash&&(this.elements.splash.style.display="flex")}hideHelp(){this.elements.splash&&(this.elements.splash.style.display="none")}announce(e){this.elements.announcer&&(this.elements.announcer.textContent=e)}};var X=class{constructor(e,t){this.canvas=e,this.eventBus=t,this.isDragging=!1,this.hasDragged=!1,this.dragOffset={x:0,y:0},this.selectedWaypoint=null,this.handleMouseDown=this.handleMouseDown.bind(this),this.handleMouseMove=this.handleMouseMove.bind(this),this.handleMouseUp=this.handleMouseUp.bind(this),this.handleCanvasClick=this.handleCanvasClick.bind(this),this.handleKeyDown=this.handleKeyDown.bind(this),this.handleDragOver=this.handleDragOver.bind(this),this.handleDrop=this.handleDrop.bind(this),this.setupEventListeners()}setupEventListeners(){this.canvas.addEventListener("mousedown",this.handleMouseDown),this.canvas.addEventListener("mousemove",this.handleMouseMove),this.canvas.addEventListener("mouseup",this.handleMouseUp),this.canvas.addEventListener("click",this.handleCanvasClick),this.canvas.addEventListener("touchstart",this.handleTouchStart.bind(this),{passive:!1}),this.canvas.addEventListener("touchmove",this.handleTouchMove.bind(this),{passive:!1}),this.canvas.addEventListener("touchend",this.handleTouchEnd.bind(this),{passive:!1}),document.addEventListener("keydown",this.handleKeyDown),this.canvas.addEventListener("dragover",this.handleDragOver),this.canvas.addEventListener("drop",this.handleDrop),this.canvas.addEventListener("contextmenu",e=>{e.preventDefault(),this.handleContextMenu(e)})}handleMouseDown(e){let t=this.canvas.getBoundingClientRect(),s=e.clientX-t.left,n=e.clientY-t.top;this.eventBus.emit("waypoint:check-at-position",{x:s,y:n},i=>{i&&(this.selectedWaypoint=i,this.isDragging=!0,this.hasDragged=!1,this.eventBus.emit("coordinate:image-to-canvas",{imgX:i.imgX,imgY:i.imgY},a=>{this.dragOffset.x=s-a.x,this.dragOffset.y=n-a.y}),this.canvas.classList.add("dragging"),this.eventBus.emit("waypoint:selected",i))})}handleMouseMove(e){if(this.isDragging&&this.selectedWaypoint){let t=this.canvas.getBoundingClientRect(),s=e.clientX-t.left,n=e.clientY-t.top;this.hasDragged=!0;let i=s-this.dragOffset.x,a=n-this.dragOffset.y;this.eventBus.emit("coordinate:canvas-to-image",{canvasX:i,canvasY:a},o=>{this.eventBus.emit("waypoint:position-changed",{waypoint:this.selectedWaypoint,imgX:o.x,imgY:o.y,isDragging:!0})})}}handleMouseUp(e){this.isDragging&&(this.isDragging=!1,this.canvas.classList.remove("dragging"),this.hasDragged&&this.eventBus.emit("waypoint:drag-ended",this.selectedWaypoint),this.selectedWaypoint=null,this.hasDragged=!1)}handleCanvasClick(e){if(this.hasDragged){this.hasDragged=!1;return}let t=this.canvas.getBoundingClientRect(),s=e.clientX-t.left,n=e.clientY-t.top;this.eventBus.emit("waypoint:check-at-position",{x:s,y:n},i=>{if(i)this.eventBus.emit("waypoint:selected",i);else{let a=!e.shiftKey;this.eventBus.emit("coordinate:canvas-to-image",{canvasX:s,canvasY:n},o=>{this.eventBus.emit("waypoint:add",{imgX:o.x,imgY:o.y,isMajor:a})})}})}handleKeyDown(e){if(e.target.tagName==="INPUT"||e.target.tagName==="TEXTAREA")return;let t=e.key.toLowerCase(),s=e.shiftKey,n=e.ctrlKey||e.metaKey;if(t===" ")e.preventDefault(),this.eventBus.emit("ui:animation:toggle");else if(t==="arrowleft"&&!s)e.preventDefault(),this.eventBus.emit("ui:animation:skip-start");else if(t==="arrowright"&&!s)e.preventDefault(),this.eventBus.emit("ui:animation:skip-end");else if(t==="j")e.preventDefault(),this.eventBus.emit("animation:speed-decrease");else if(t==="k")e.preventDefault(),this.eventBus.emit("animation:speed-reset");else if(t==="l")e.preventDefault(),this.eventBus.emit("animation:speed-increase");else if(s&&this.selectedWaypoint){let i=n?10:1,a=0,o=0;switch(t){case"arrowup":o=-i;break;case"arrowdown":o=i;break;case"arrowleft":a=-i;break;case"arrowright":a=i;break;default:return}(a!==0||o!==0)&&(e.preventDefault(),this.eventBus.emit("waypoint:move-by-pixels",{waypoint:this.selectedWaypoint,dx:a,dy:o}))}else if((t==="delete"||t==="backspace")&&this.selectedWaypoint)e.preventDefault(),this.eventBus.emit("waypoint:delete-selected");else if(t==="tab"){e.preventDefault();let i=s?"previous":"next";this.eventBus.emit("waypoint:select-adjacent",i)}else t==="t"&&this.selectedWaypoint?(e.preventDefault(),this.eventBus.emit("waypoint:toggle-type",this.selectedWaypoint)):n&&t==="z"?(e.preventDefault(),s?this.eventBus.emit("history:redo"):this.eventBus.emit("history:undo")):n&&t==="s"?(e.preventDefault(),this.eventBus.emit("file:save")):(t==="?"||t==="h")&&!n&&(e.preventDefault(),this.eventBus.emit("help:toggle"))}handleTouchStart(e){if(e.touches.length===1){let t=e.touches[0],s=this.canvas.getBoundingClientRect(),n=t.clientX-s.left,i=t.clientY-s.top;this.handleMouseDown({clientX:t.clientX,clientY:t.clientY})}}handleTouchMove(e){if(e.touches.length===1&&this.isDragging){e.preventDefault();let t=e.touches[0];this.handleMouseMove({clientX:t.clientX,clientY:t.clientY})}}handleTouchEnd(e){if(e.changedTouches.length===1){let t=e.changedTouches[0];this.handleMouseUp({clientX:t.clientX,clientY:t.clientY}),this.hasDragged||this.handleCanvasClick({clientX:t.clientX,clientY:t.clientY,shiftKey:!1})}}handleDragOver(e){e.preventDefault(),e.dataTransfer.dropEffect="copy",this.canvas.classList.add("drag-over")}handleDrop(e){e.preventDefault(),this.canvas.classList.remove("drag-over");let t=e.dataTransfer.files;if(t.length>0){let s=t[0];s.type.startsWith("image/")&&this.eventBus.emit("background:upload",s)}}handleContextMenu(e){let t=this.canvas.getBoundingClientRect(),s=e.clientX-t.left,n=e.clientY-t.top;this.eventBus.emit("waypoint:check-at-position",{x:s,y:n},i=>{i?this.eventBus.emit("waypoint:show-context-menu",{waypoint:i,x:e.clientX,y:e.clientY}):this.eventBus.emit("canvas:show-context-menu",{x:e.clientX,y:e.clientY,canvasX:s,canvasY:n})})}setSelectedWaypoint(e){this.selectedWaypoint=e}destroy(){this.canvas.removeEventListener("mousedown",this.handleMouseDown),this.canvas.removeEventListener("mousemove",this.handleMouseMove),this.canvas.removeEventListener("mouseup",this.handleMouseUp),this.canvas.removeEventListener("click",this.handleCanvasClick),document.removeEventListener("keydown",this.handleKeyDown),this.canvas.removeEventListener("dragover",this.handleDragOver),this.canvas.removeEventListener("drop",this.handleDrop)}};var V=class{constructor(){this.storageService=new D,this.coordinateTransform=new O,this.pathCalculator=new H,this.renderingService=new U,this.eventBus=new Y,this.animationEngine=new F(this.eventBus),this.renderQueued=!1,this._batchMode=!1,this._lastDisplayedSecond=-1,this._majorWaypointsCache=null,this._durationUpdateTimeout=null,this.canvas=document.getElementById("canvas"),this.ctx=this.canvas.getContext("2d"),this.waypoints=[],this.waypointsById=new Map,this.pathPoints=[],this.selectedWaypoint=null,this.isDragging=!1,this.hasDragged=!1,this.dragOffset={x:0,y:0},this.styles={pathColor:"#FF6B6B",pathThickness:3,pathStyle:"solid",pathShape:"line",markerStyle:"dot",dotColor:"#FF6B6B",dotSize:S.DEFAULT_DOT_SIZE,beaconStyle:"pulse",beaconColor:"#FF6B6B",labelMode:"none",labelPosition:"auto",pathHead:{style:"arrow",color:"#111111",size:8,image:null,rotation:0}},this.beaconAnimation={pulsePhase:0,ripples:[]},this.background={image:null,overlay:0,fit:"fit"},this.vectorCanvas=null,this.labels={active:[],fadeTime:S.LABEL_FADE_TIME},this.elements={canvas:document.getElementById("canvas"),waypoints:document.getElementById("waypoints-tab"),settings:document.getElementById("settings-tab"),tabBtns:document.querySelectorAll(".tab-btn"),waypointList:document.getElementById("waypoint-list"),bgUploadBtn:document.getElementById("bg-upload-btn"),bgUpload:document.getElementById("bg-upload"),bgOverlay:document.getElementById("bg-overlay"),bgOverlayValue:document.getElementById("bg-overlay-value"),bgFitToggle:document.getElementById("bg-fit-toggle"),playBtn:document.getElementById("play-btn"),pauseBtn:document.getElementById("pause-btn"),skipStartBtn:document.getElementById("skip-start-btn"),skipEndBtn:document.getElementById("skip-end-btn"),timelineSlider:document.getElementById("timeline-slider"),currentTime:document.getElementById("current-time"),totalTime:document.getElementById("total-time"),animationSpeed:document.getElementById("animation-speed"),animationSpeedValue:document.getElementById("animation-speed-value"),speedControl:document.getElementById("speed-control"),waypointEditor:document.getElementById("waypoint-editor"),waypointEditorPlaceholder:document.getElementById("waypoint-editor-placeholder"),waypointPauseTime:document.getElementById("waypoint-pause-time"),waypointPauseTimeValue:document.getElementById("waypoint-pause-time-value"),pauseTimeControl:document.getElementById("pause-time-control"),splash:document.getElementById("splash"),splashClose:document.getElementById("splash-close"),splashDontShow:document.getElementById("splash-dont-show"),segmentColor:document.getElementById("segment-color"),segmentWidth:document.getElementById("segment-width"),segmentWidthValue:document.getElementById("segment-width-value"),segmentStyle:document.getElementById("segment-style"),dotColor:document.getElementById("dot-color"),dotSize:document.getElementById("dot-size"),dotSizeValue:document.getElementById("dot-size-value"),markerStyle:document.getElementById("marker-style"),pathShape:document.getElementById("path-shape"),editorBeaconStyle:document.getElementById("editor-beacon-style"),editorBeaconColor:document.getElementById("editor-beacon-color"),waypointLabel:document.getElementById("waypoint-label"),labelMode:document.getElementById("label-mode"),labelPosition:document.getElementById("label-position"),helpBtn:document.getElementById("help-btn"),clearBtn:document.getElementById("clear-btn"),announcer:document.getElementById("announcer"),pathHeadStyle:document.getElementById("path-head-style"),pathHeadColor:document.getElementById("path-head-color"),pathHeadSize:document.getElementById("path-head-size"),pathHeadSizeValue:document.getElementById("path-head-size-value"),customHeadControls:document.getElementById("custom-head-controls"),headUploadBtn:document.getElementById("head-upload-btn"),headUpload:document.getElementById("head-upload"),headPreview:document.getElementById("head-preview"),headFilename:document.getElementById("head-filename"),headPreviewImg:document.getElementById("head-preview-img")},this.init()}init(){this.resizeCanvas(),window.addEventListener("resize",()=>{this.resizeCanvas(),this.render()}),this.elements.markerStyle.value=this.styles.markerStyle,this.elements.pathShape.value=this.styles.pathShape,this.elements.pathHeadStyle.value=this.styles.pathHead.style,this.elements.pathHeadColor.value=this.styles.pathHead.color,this.elements.pathHeadSize.value=this.styles.pathHead.size,this.elements.pathHeadSizeValue.textContent=this.styles.pathHead.size,this.elements.customHeadControls.style.display=this.styles.pathHead.style==="custom"?"block":"none";let e=this.animationEngine.state.duration/1e3;this.elements.animationSpeedValue.textContent=e+"s",this.setupEventListeners(),this.setupEventBusListeners(),this.uiController=new j(this.elements,this.eventBus),this.interactionHandler=new X(this.canvas,this.eventBus);let t=this.animationEngine.state.speed||C.DEFAULT_SPEED,s=performance.now().toFixed(2);console.log("\u{1F680} [".concat(s,"ms] [init] Setting initial slider speed:"),t),this.eventBus.emit("ui:slider:update-speed",t),this.setupControllerEventConnections(),this.storageService.shouldShowSplash()&&this.showSplash(),this.loadAutosave(),this.background.image||this.loadDefaultImage(),this.animationEngine.setWaypointCheckCallback(n=>{let i=this.getMajorWaypointPositions();i.length>0&&this.checkForWaypointWait(n,i)}),this.setupAnimationEngineListeners(),this.animationEngine.seekToProgress(1),this.animationEngine.pause(),this.render(),this.startRenderLoop(),console.log("Route Plotter v3 initialized")}resizeCanvas(){let e=this.canvas.getBoundingClientRect(),t=S.CONTROLS_HEIGHT,s=window.devicePixelRatio||1,n=Math.min(s*2,3);this.canvas.width=e.width*n,this.canvas.height=e.height*n,this.canvasScale=n,this.ctx.scale(n,n),this.ctx.imageSmoothingEnabled=!1,this.displayWidth=e.width,this.displayHeight=e.height-t,this.coordinateTransform.setCanvasDimensions(this.displayWidth,this.displayHeight),console.log("Canvas resized to:",e.width,"x",e.height,"at",n+"x scale","(usable height:",this.displayHeight+")"),this.render()}setupEventListeners(){document.querySelectorAll(".tab-btn").forEach(e=>{e.addEventListener("click",t=>{let s=t.target.dataset.tab;document.querySelectorAll(".tab-btn").forEach(n=>n.classList.remove("active")),t.target.classList.add("active"),document.querySelectorAll(".tab-content").forEach(n=>n.classList.remove("active")),document.getElementById("".concat(s,"-tab")).classList.add("active")})}),console.log("\u{1F527} [Splash] Setting up event listeners:",{splash:!!this.elements.splash,splashClose:!!this.elements.splashClose,splashDontShow:!!this.elements.splashDontShow}),this.elements.splashClose?this.elements.splashClose.addEventListener("click",e=>{console.log("\u{1F3AF} [Splash] Close button clicked"),e.stopPropagation(),this.hideSplash()}):console.error("\u274C [Splash] Close button element not found!"),this.elements.splash?this.elements.splash.addEventListener("click",e=>{console.log("\u{1F3AF} [Splash] Background clicked, target:",e.target.id||e.target.className),e.target===this.elements.splash?(console.log("\u2705 [Splash] Closing splash (background click)"),this.hideSplash()):console.log("\u274C [Splash] Not closing (clicked on content)")}):console.error("\u274C [Splash] Splash element not found!")}queueRender(){this.renderQueued||(this.renderQueued=!0,requestAnimationFrame(()=>{this.render(),this.renderQueued=!1}))}beginBatch(){this._batchMode=!0}endBatch(){this._batchMode=!1,this.waypoints.length>=2&&this.calculatePath(),this.updateWaypointList(),this.autoSave(),this.queueRender()}getWaypointById(e){return this.waypointsById.get(e)}_addWaypointToMap(e){this.waypointsById.set(e.id,e)}_removeWaypointFromMap(e){this.waypointsById.delete(e.id)}setupEventBusListeners(){this.eventBus.on("waypoint:added",e=>{if(!(e instanceof B)){console.error("Invalid waypoint: not a Waypoint instance",e);return}this._addWaypointToMap(e),this._majorWaypointsCache=null,!this._batchMode&&(this.waypoints.length>=2&&this.calculatePath(),this.updateWaypointList(),this.autoSave(),this.queueRender())}),this.eventBus.on("waypoint:deleted",e=>{this._majorWaypointsCache=null,this.waypoints.length>=2?this.calculatePath():this.pathPoints=[],this.updateWaypointList(),this.updateWaypointEditor(),this.autoSave(),this.queueRender()}),this.eventBus.on("waypoint:selected",e=>{this.updateWaypointEditor(),this.queueRender()}),this.eventBus.on("waypoint:position-changed",e=>{(e.imgX<0||e.imgX>1||e.imgY<0||e.imgY>1)&&(console.warn("Waypoint position out of bounds, clamping:",e.id),e.setPosition(e.imgX,e.imgY)),this.calculatePath(),this.updateWaypointList(),this.autoSave(),this.queueRender()}),this.eventBus.on("waypoint:style-changed",e=>{this.queueRender(),this.autoSave()}),this.eventBus.on("waypoint:path-property-changed",e=>{this.calculatePath(),this.autoSave(),this.queueRender()})}setupAnimationEngineListeners(){this.eventBus.on("animation:play",()=>{this.elements.playBtn.style.display="none",this.elements.pauseBtn.style.display="inline-block",this.announce("Playing animation")}),this.eventBus.on("animation:pause",()=>{this.elements.playBtn.style.display="inline-block",this.elements.pauseBtn.style.display="none",this.announce("Animation paused")}),this.eventBus.on("animation:complete",()=>{this.elements.playBtn.style.display="inline-block",this.elements.pauseBtn.style.display="none",this.announce("Animation complete")}),this.eventBus.on("animation:reset",()=>{let e=performance.now().toFixed(2);this.elements.playBtn.style.display="inline-block",this.elements.pauseBtn.style.display="none",this.announce("Animation reset");let t=this.animationEngine.state.speed;if(console.log("\u{1F527} [".concat(e,"ms] [animation:reset] Syncing slider to preserved speed:"),t),console.trace("Reset origin"),this.pathPoints&&this.pathPoints.length>0){let s=this.pathCalculator.calculatePathLength(this.pathPoints),n=s/t*1e3;console.log("\u{1F4CF} [".concat(e,"ms] [animation:reset] Recalculating duration - length:"),s.toFixed(1),"speed:",t,"duration:",(n/1e3).toFixed(1)+"s"),this.animationEngine.setDuration(n);let i=Math.round(n/100)/10;this.elements.animationSpeedValue.textContent=i+"s"}this.eventBus.emit("ui:slider:update-speed",t)}),this.eventBus.on("animation:waypointWaitEnd",e=>{console.log("Wait complete at waypoint",e),this.announce("Continuing animation")})}setupControllerEventConnections(){this.eventBus.on("background:upload",e=>{this.loadImageFile(e).then(t=>{this.background.image=t,this.updateImageTransform(t),this.waypoints.length>=2&&this.calculatePath(),this.render(),this.autoSave()})}),this.eventBus.on("background:overlay-change",e=>{this.background.overlay=e,this.render(),this.autoSave()}),this.eventBus.on("background:mode-change",e=>{this.background.fit=e,this.coordinateTransform.fitMode=e,this.updateImageTransform(this.background.image),this.render(),this.autoSave()}),this.eventBus.on("ui:animation:play",()=>{console.log("\u25B6\uFE0F  [UI Event] ui:animation:play - progress:",this.animationEngine.getProgress()),this.animationEngine.getProgress()>=1&&(console.log("\u{1F504} [UI Event] Progress at 100%, calling reset()"),this.animationEngine.reset()),this.animationEngine.play()}),this.eventBus.on("ui:animation:pause",()=>this.animationEngine.pause()),this.eventBus.on("ui:animation:skip-start",()=>{console.log("\u23EA [UI Event] ui:animation:skip-start - calling reset()"),this.animationEngine.reset()}),this.eventBus.on("ui:animation:skip-end",()=>this.animationEngine.seekToProgress(1)),this.eventBus.on("ui:animation:seek",e=>this.animationEngine.seekToProgress(e)),this.eventBus.on("animation:speed-change",e=>{let t=performance.now().toFixed(2);if(console.log("\u{1F3AF} [".concat(t,"ms] [Event] animation:speed-change - new speed:"),e,"px/s"),console.trace("Speed change origin"),this.animationEngine.setSpeed(e),this.pathPoints&&this.pathPoints.length>0){let s=this.pathCalculator.calculatePathLength(this.pathPoints),n=s/e*1e3;console.log("\u{1F4CF} [Event] Recalculating duration - length:",s.toFixed(1),"speed:",e,"duration:",(n/1e3).toFixed(1)+"s"),this.animationEngine.setDuration(n);let i=Math.round(n/100)/10;this.elements.animationSpeedValue.textContent=i+"s"}else{let s=1e4/e*this.animationEngine.state.speed,n=Math.round(s/100)/10;this.elements.animationSpeedValue.textContent=n+"s"}this.updateTimeDisplay(),this.autoSave()}),this.eventBus.on("ui:animation:toggle",()=>{this.animationEngine.state.isPlaying?this.animationEngine.pause():this.animationEngine.play()}),this.eventBus.on("animation:speed-decrease",()=>{let e=this.animationEngine.state.playbackSpeed;this.animationEngine.setPlaybackSpeed(Math.max(.1,e-.1))}),this.eventBus.on("animation:speed-reset",()=>{this.animationEngine.setPlaybackSpeed(1)}),this.eventBus.on("animation:speed-increase",()=>{let e=this.animationEngine.state.playbackSpeed;this.animationEngine.setPlaybackSpeed(Math.min(10,e+.1))}),this.eventBus.on("waypoint:add",e=>{let t=e.isMajor?B.createMajor(e.imgX,e.imgY):B.createMinor(e.imgX,e.imgY);if(this.waypoints.length>0){let s=this.waypoints[this.waypoints.length-1];t.copyPropertiesFrom(s)}this.waypoints.push(t),this._addWaypointToMap(t),this.eventBus.emit("waypoint:added",t)}),this.eventBus.on("waypoint:position-changed",e=>{let{waypoint:t,imgX:s,imgY:n,isDragging:i}=e;t.imgX=s,t.imgY=n,i||this.autoSave(),this.eventBus.emit("waypoint:position-updated",t)}),this.eventBus.on("waypoint:selected",e=>{var t,s;this.selectedWaypoint=e,(t=this.interactionHandler)==null||t.setSelectedWaypoint(e),(s=this.uiController)==null||s.updateWaypointEditor(e),this.updateWaypointList()}),this.eventBus.on("waypoint:deleted",e=>{this.deleteWaypoint(e)}),this.eventBus.on("waypoint:delete-selected",()=>{this.selectedWaypoint&&(this.deleteWaypoint(this.selectedWaypoint),this.selectedWaypoint=null)}),this.eventBus.on("waypoints:clear-all",()=>{this.clearAll()}),this.eventBus.on("waypoints:reordered",e=>{let t=[...this.waypoints],s=t.filter(i=>!i.isMajor);this.waypoints=[];let n=0;t.forEach(i=>{i.isMajor?(this.waypoints.push(e[n]),n++):this.waypoints.push(i)}),this.waypoints.length>=2&&this.calculatePath(),this.updateWaypointList(),this.autoSave(),this.render()}),this.eventBus.on("coordinate:canvas-to-image",(e,t)=>{let s=this.canvasToImage(e.canvasX,e.canvasY);t&&t(s)}),this.eventBus.on("coordinate:image-to-canvas",(e,t)=>{let s=this.imageToCanvas(e.imgX,e.imgY);t&&t(s)}),this.eventBus.on("waypoint:check-at-position",(e,t)=>{let s=this.findWaypointAt(e.x,e.y);t&&t(s)}),this.eventBus.on("help:toggle",()=>{this.elements.splash.style.display==="none"||this.elements.splash.style.display===""?this.showSplash():this.hideSplash()}),this.eventBus.on("pathhead:style-changed",e=>{this.styles.pathHead.style=e,this.render(),this.autoSave()}),this.eventBus.on("pathhead:color-changed",e=>{this.styles.pathHead.color=e,this.render(),this.autoSave()}),this.eventBus.on("pathhead:size-changed",e=>{this.styles.pathHead.size=e,this.render(),this.autoSave()})}findWaypointAt(e,t){let s=G.WAYPOINT_HIT_RADIUS;return this.waypoints.find(n=>{let i=this.imageToCanvas(n.imgX,n.imgY);return Math.sqrt(Math.pow(i.x-e,2)+Math.pow(i.y-t,2))<=s})}updateWaypointList(){if(this.uiController){this.uiController.updateWaypointList(this.waypoints);return}this.elements.waypointList.innerHTML="",this.waypoints.filter(t=>t.isMajor).forEach((t,s)=>{let n=document.createElement("div");n.className="waypoint-item",t===this.selectedWaypoint&&n.classList.add("selected");let i=document.createElement("span");i.className="waypoint-item-handle",i.textContent="\u2630";let a=document.createElement("span");a.className="waypoint-item-label",a.textContent="Waypoint ".concat(s+1);let o=document.createElement("button");o.className="waypoint-item-delete",o.textContent="\xD7",n.appendChild(i),n.appendChild(a),n.appendChild(o);let h=r=>{r.stopPropagation(),this.selectedWaypoint=t,this.updateWaypointList(),this.updateWaypointEditor()};a.addEventListener("click",h),i.addEventListener("click",h),n.addEventListener("click",h),o.addEventListener("click",r=>{r.stopPropagation(),this.deleteWaypoint(t)}),this.elements.waypointList.appendChild(n)})}updateWaypointEditor(){if(this.selectedWaypoint)if(this.elements.waypointEditor.style.display="block",this.elements.waypointEditorPlaceholder.style.display="none",this.elements.segmentColor.value=this.selectedWaypoint.segmentColor,this.elements.segmentWidth.value=this.selectedWaypoint.segmentWidth,this.elements.segmentWidthValue.textContent=this.selectedWaypoint.segmentWidth,this.elements.segmentStyle.value=this.selectedWaypoint.segmentStyle||"solid",this.elements.pathShape.value=this.selectedWaypoint.pathShape||"line",this.elements.markerStyle.value=this.selectedWaypoint.markerStyle||"dot",this.elements.dotColor.value=this.selectedWaypoint.dotColor||this.selectedWaypoint.segmentColor||this.styles.dotColor,this.elements.dotSize.value=this.selectedWaypoint.dotSize||this.styles.dotSize,this.elements.dotSizeValue.textContent=this.elements.dotSize.value,this.elements.pathHeadStyle.value=this.selectedWaypoint.pathHeadStyle||this.styles.pathHead.style,this.elements.pathHeadColor.value=this.selectedWaypoint.pathHeadColor||this.styles.pathHead.color,this.elements.pathHeadSize.value=this.selectedWaypoint.pathHeadSize||this.styles.pathHead.size,this.elements.pathHeadSizeValue.textContent=this.elements.pathHeadSize.value,this.elements.customHeadControls.style.display=(this.selectedWaypoint.pathHeadStyle||this.styles.pathHead.style)==="custom"?"block":"none",this.selectedWaypoint.isMajor){this.elements.dotColor.disabled=!1,this.elements.dotSize.disabled=!1,this.elements.editorBeaconStyle.disabled=!1,this.elements.editorBeaconColor.disabled=!1,this.elements.editorBeaconStyle.value=this.selectedWaypoint.beaconStyle||this.styles.beaconStyle,this.elements.editorBeaconColor.value=this.selectedWaypoint.beaconColor||this.styles.beaconColor,this.elements.waypointLabel.disabled=!1,this.elements.labelMode.disabled=!1,this.elements.labelPosition.disabled=!1,this.elements.waypointLabel.value=this.selectedWaypoint.label||"",this.elements.labelMode.value=this.selectedWaypoint.labelMode||"none",this.elements.labelPosition.value=this.selectedWaypoint.labelPosition||"auto",this.elements.waypointPauseTime.disabled=!1;let e=(this.selectedWaypoint.pauseTime||0)/1e3;this.elements.waypointPauseTime.value=e,this.elements.waypointPauseTimeValue.textContent=e+"s",this.elements.pauseTimeControl.style.display="flex"}else this.elements.dotColor.disabled=!0,this.elements.dotSize.disabled=!0,this.elements.editorBeaconStyle.disabled=!0,this.elements.editorBeaconColor.disabled=!0,this.elements.editorBeaconStyle.value="none",this.elements.editorBeaconColor.value=this.styles.beaconColor,this.elements.waypointLabel.disabled=!0,this.elements.labelMode.disabled=!0,this.elements.labelPosition.disabled=!0,this.elements.waypointLabel.value="",this.elements.labelMode.value="none",this.elements.labelPosition.value="auto",this.elements.waypointPauseTime.disabled=!0,this.elements.waypointPauseTime.value=0,this.elements.waypointPauseTimeValue.textContent="0s",this.elements.pauseTimeControl.style.display="none";else this.elements.waypointEditor.style.display="none",this.elements.waypointEditorPlaceholder.style.display="flex"}deleteWaypoint(e){let t=this.waypoints.indexOf(e);t>-1&&(this.waypoints.splice(t,1),this._removeWaypointFromMap(e),this.selectedWaypoint===e&&(this.selectedWaypoint=null),this.eventBus.emit("waypoint:deleted",t),this.announce("Waypoint deleted"))}updateImageTransform(e){if(!e)return;let t=e.naturalWidth||e.width,s=e.naturalHeight||e.height;this.coordinateTransform.setImageDimensions(t,s,this.background.fit)}canvasToImage(e,t){return this.coordinateTransform.canvasToImage(e,t)}imageToCanvas(e,t){return this.coordinateTransform.imageToCanvas(e,t)}async calculatePath(){if(this.pathPoints=[],this.waypoints.length<2)return;let e=this.waypoints.map(t=>{let s=this.imageToCanvas(t.imgX,t.imgY);return W(w({},t),{x:s.x,y:s.y})});try{this.pathPoints=await this.pathCalculator.calculatePathAsync(e)}catch(t){console.warn("Async path calculation failed, falling back to sync:",t),this.pathPoints=this.pathCalculator.calculatePath(e)}this._durationUpdateTimeout&&clearTimeout(this._durationUpdateTimeout),this._durationUpdateTimeout=setTimeout(()=>{if(this.animationEngine.state.mode==="constant-speed"){let t=this.pathCalculator.calculatePathLength(this.pathPoints),s=this.animationEngine.state.speed,n=t/s*1e3;console.log("\u{1F6E4}\uFE0F  [calculatePath] Updating duration - speed:",s,"px/s, length:",t.toFixed(1),"px, duration:",(n/1e3).toFixed(1)+"s"),this.animationEngine.setDuration(n);let i=Math.round(n/100)/10;this.elements.animationSpeedValue.textContent=i+"s"}this.updateTimeDisplay()},50)}getMajorWaypointPositions(){if(this.waypoints.length<2)return[];if(this._majorWaypointsCache)return this._majorWaypointsCache;let e=[],t=this.waypoints.length-1;for(let s=0;s<this.waypoints.length;s++)if(this.waypoints[s].isMajor){let n=s/t;e.push({index:s,progress:n,waypoint:this.waypoints[s]})}return this._majorWaypointsCache=e,e}applyEasing(e,t){for(let s of t)if(s.waypoint&&s.waypoint.pauseMode==="timed"&&Math.abs(e-s.progress)<.001)return s.progress;return I.cubicInOut(e)}findSegmentIndexForProgress(e){if(this.waypoints.length<2)return-1;let t=this.waypoints.length-1,n=Math.max(0,Math.min(1,e))*t,i=Math.floor(n);return Math.min(i,t-1)}checkForWaypointWait(e,t){if(this.animationEngine.state.isWaitingAtWaypoint||this.animationEngine.state.isPaused)return;let s=.01,n=t.filter(l=>Math.abs(e-l.progress)<s);if(n.length===0||this.findSegmentIndexForProgress(e)<0)return;e<.01&&console.log("All major waypoints:",t.map(l=>({index:l.index,progress:l.progress,pauseMode:l.waypoint&&l.waypoint.pauseMode})));let a=null,o=1/0;for(let l of n){if(l.index===this.animationEngine.state.pauseWaypointIndex)continue;let u=l.waypoint&&l.waypoint.pauseMode,c=l.waypoint&&l.waypoint.pauseTime;if(!l.waypoint||u!=="timed"||!c||c<=0)continue;let y=l.index/(this.waypoints.length-1)-e;y>-.005&&y<o&&(o=y,a=l)}if(!a)return;let h=a.index/(this.waypoints.length-1);if(Math.abs(e-h)<.005&&e>=h-.005){console.log("WAITING at waypoint ".concat(a.index," (progress ").concat(a.progress.toFixed(3),")"),a.waypoint),this.animationEngine.startWaypointWait(a.index,a.waypoint.pauseTime);let l=a.waypoint.pauseTime/1e3;this.announce("Waiting at waypoint ".concat(a.index+1," for ").concat(l," seconds"))}}continueAnimation(){}play(){this.waypoints.length<2||(this.animationEngine.state.progress>=1&&this.animationEngine.reset(),this.animationEngine.play())}pause(){this.animationEngine.pause()}skipToStart(){this.animationEngine.reset(),this.announce("Skipped to start")}skipToEnd(){this.animationEngine.seekToProgress(1),this.announce("Skipped to end")}clearAll(){this.waypoints=[],this.waypointsById.clear(),this.pathPoints=[],this.selectedWaypoint=null,this.animationEngine.reset(),this.animationEngine.setDuration(0),this.pause(),this.updateTimeDisplay(),this.updateWaypointList(),console.log("Cleared all waypoints and path")}showSplash(){console.log("\u{1F4D6} [Splash] Showing splash screen"),this.elements.splash.style.display="flex"}hideSplash(){console.log("\u{1F6AB} [Splash] Hiding splash screen"),this.elements.splash.style.display="none",this.elements.splashDontShow.checked&&(console.log('\u2705 [Splash] Marking as "don\'t show again"'),this.storageService.markSplashShown())}announce(e,t="polite"){let s=document.getElementById("announcer");s&&(s.setAttribute("aria-live",t),s.textContent=e,setTimeout(()=>{s.textContent=""},2e3))}autoSave(){try{let e=w({},this.styles);e.pathHead&&e.pathHead.image&&(e.pathHead=W(w({},e.pathHead),{image:null}));let t={coordVersion:6,waypoints:this.waypoints.map(s=>s.toJSON()),styles:e,animationState:{mode:this.animationEngine.state.mode,speed:this.animationEngine.state.speed,duration:this.animationEngine.state.duration,playbackSpeed:this.animationEngine.state.playbackSpeed},background:{overlay:this.background.overlay,fit:this.background.fit}};this.storageService.autoSave(t)}catch(e){console.error("Error saving state:",e)}}loadAutosave(){var e,t;console.log("\u{1F4E5} [loadAutosave] Loading saved state...");try{let s=this.storageService.loadAutoSave();if(!s)return;let n=6;if(!s.coordVersion||s.coordVersion<n){console.log("Old data version detected (v"+(s.coordVersion||1)+"), clearing saved data for v"+n),this.storageService.clearAutoSave();return}if(s.waypoints&&Array.isArray(s.waypoints)&&(this.beginBatch(),this.waypoints=s.waypoints.map(i=>B.validate(i)?B.fromJSON(i):(console.warn("Invalid waypoint data, skipping:",i),null)).filter(i=>i!==null),this.waypoints.forEach(i=>this._addWaypointToMap(i)),this.endBatch(),console.log("Loaded waypoints:",this.waypoints.length)),s.styles&&(this.styles=w(w({},this.styles),s.styles)),s.animationState){let i=s.animationState;if(this.animationEngine.setMode(i.mode||"constant-speed"),this.animationEngine.setSpeed(i.speed||C.DEFAULT_SPEED),this.animationEngine.setPlaybackSpeed(i.playbackSpeed||1),this.elements.animationSpeed){let a=i.speed||C.DEFAULT_SPEED;console.log("\u{1F3AF} [loadAutosave] Setting slider to:",a,"(from savedState.speed:",i.speed,")"),this.eventBus.emit("ui:slider:update-speed",a)}this.elements.speedControl&&(this.elements.speedControl.style.display="flex")}s.background&&(this.background.overlay=(e=s.background.overlay)!=null?e:this.background.overlay,this.background.fit=(t=s.background.fit)!=null?t:this.background.fit,this.elements.bgFitToggle&&(this.elements.bgFitToggle.textContent=this.background.fit==="fit"?"Fit":"Fill",this.elements.bgFitToggle.dataset.mode=this.background.fit),this.elements.bgOverlay&&(this.elements.bgOverlay.value=String(this.background.overlay),this.elements.bgOverlayValue.textContent=String(this.background.overlay))),this.calculatePath(),this.updateWaypointList(),this.animationEngine.seekToProgress(1),this.animationEngine.pause(),this.announce("Previous session restored")}catch(s){console.warn("No autosave found or failed to load")}}startRenderLoop(){let e=-1,t=!1;this.animationEngine.start(s=>{let n=Math.abs(s.progress-e)>1e-4,i=s.isWaitingAtWaypoint!==t;(s.isPlaying||n||i)&&(this.syncUIWithAnimationState(s),this.render(),e=s.progress,t=s.isWaitingAtWaypoint)})}syncUIWithAnimationState(e){let t=e.currentTime/e.duration;this.elements.timelineSlider.value=t*C.TIMELINE_RESOLUTION;let s=Math.floor(e.currentTime/1e3);s!==this._lastDisplayedSecond&&(this.updateTimeDisplay(e.currentTime,e.duration),this._lastDisplayedSecond=s)}updateTimeDisplay(e=null,t=null){let s=a=>{let o=Math.floor(a/1e3),h=Math.floor(o/60),r=o%60;return"".concat(h,":").concat(r.toString().padStart(2,"0"))},n=e!==null?e:this.animationEngine.state.currentTime,i=t!==null?t:this.animationEngine.state.duration;this.elements.currentTime.textContent=s(n),this.elements.totalTime.textContent=s(i)}render(){let{ctx:e}=this,t=this.displayWidth||this.canvas.width,s=this.displayHeight||this.canvas.height;if(t<=0||s<=0){console.warn("Cannot render to canvas with invalid dimensions:",{width:t,height:s});return}e.clearRect(0,0,t,s),this.renderBackground(e),this.renderOverlay(e);let n=this.getVectorCanvas();if(n.width<=0||n.height<=0){console.warn("Vector canvas has invalid dimensions:",{width:n.width,height:n.height});return}let i=n.getContext("2d");i.clearRect(0,0,n.width,n.height),this.renderVectorLayerTo(i),n.width>0&&n.height>0&&e.drawImage(n,0,0)}getVectorCanvas(){this.vectorCanvas||(this.vectorCanvas=document.createElement("canvas"));let e=this.displayWidth||this.canvas.width||100,t=this.displayHeight||this.canvas.height||100,s=Math.max(1,e),n=Math.max(1,t);if(this.vectorCanvas.width!==s||this.vectorCanvas.height!==n){console.log("Resizing vector canvas to:",s,"x",n),this.vectorCanvas.width=s,this.vectorCanvas.height=n;let i=this.vectorCanvas.getContext("2d");i&&(i.imageSmoothingEnabled=!1)}return this.vectorCanvas}renderBackground(e){if(!this.background.image)return;let t=this.background.image,s=t.naturalWidth||t.width,n=t.naturalHeight||t.height,i=this.displayWidth||this.canvas.width,a=this.displayHeight||this.canvas.height;if(this.background.fit==="fit"){let o=Math.min(i/s,a/n),h=Math.round(s*o),r=Math.round(n*o),l=Math.floor((i-h)/2),u=Math.floor((a-r)/2);e.drawImage(t,0,0,s,n,l,u,h,r)}else{let o=Math.max(i/s,a/n),h=i/o,r=a/o,l=(s-h)/2,u=(n-r)/2;e.drawImage(t,l,u,h,r,0,0,i,a)}}renderOverlay(e){let t=this.background.overlay;if(t===0)return;let s=this.displayWidth||this.canvas.width,n=this.displayHeight||this.canvas.height;e.save(),e.globalAlpha=Math.min(Math.abs(t)/100,.6),e.fillStyle=t<0?"#000":"#fff",e.fillRect(0,0,s,n),e.restore()}renderVectorLayerTo(e){let t=this.ctx;if(this.ctx=e,this.pathPoints.length>0&&this.waypoints.length>1){let s=this.pathPoints.length,n=this.animationEngine.getProgress(),i=Math.floor(s*n),a=this.waypoints.length-1,o=Math.floor(s/a),h=new Array(a);this.waypointPositions=[],this.waypoints.forEach((l,u)=>{if(u<this.waypoints.length-1){let c=u/a*s;this.waypointPositions.push({waypointIndex:u,pointIndex:c})}});let r=-1;for(let l=0;l<a;l++)this.waypoints[l].isMajor&&(r=l),h[l]=r;for(let l=1;l<i;l++){let u=Math.min(Math.floor(l/o),a-1),c=h[u],g=c>=0?this.waypoints[c]:{segmentColor:this.styles.pathColor,segmentWidth:this.styles.pathThickness,segmentStyle:"solid",pathShape:"line"};this.ctx.strokeStyle=g.segmentColor,this.ctx.lineWidth=g.segmentWidth,this.ctx.lineCap="round",this.ctx.lineJoin="round",this.applyLineStyle(g.segmentStyle),this.ctx.beginPath();let y=g.pathShape||"line",d=this.pathPoints[l-1],p=this.pathPoints[l];if(y==="squiggle"){let m=(d.x+p.x)/2,f=(d.y+p.y)/2,E=-(p.y-d.y)*.15,T=(p.x-d.x)*.15;this.ctx.moveTo(d.x,d.y);let v=Math.sin(l*.5)*.5;this.ctx.quadraticCurveTo(m+E*v,f+T*v,p.x,p.y)}else if(y==="randomised"){let f={x:d.x+(Math.random()-.5)*3,y:d.y+(Math.random()-.5)*3},E={x:p.x+(Math.random()-.5)*3,y:p.y+(Math.random()-.5)*3};this.ctx.moveTo(f.x,f.y),this.ctx.lineTo(E.x,E.y)}else this.ctx.moveTo(d.x,d.y),this.ctx.lineTo(p.x,p.y);this.ctx.stroke()}if(this.ctx.setLineDash([]),i>1){let l=Math.min(i-1,this.pathPoints.length-1),u=this.pathPoints[l],c=0;if(l>0){let g=this.pathPoints[l-1];c=Math.atan2(u.y-g.y,u.x-g.x)}this.styles.pathHead.rotation=c,this.drawPathHead(u.x,u.y,c)}}if(this.pathPoints.length>0){let s=this.animationEngine.getProgress(),n=this.pathPoints.length;this.waypoints.forEach((i,a)=>{if(i.isMajor){let o=a/(this.waypoints.length-1),h=Math.abs(s-o)<.001,r=this.animationEngine.state.isPaused&&this.animationEngine.state.pauseWaypointIndex===a;if(h||r){let l=this.imageToCanvas(i.imgX,i.imgY);this.drawBeacon(W(w({},i),{x:l.x,y:l.y}))}}})}this.waypoints.forEach(s=>{if(s.isMajor){let n=this.imageToCanvas(s.imgX,s.imgY),i=s===this.selectedWaypoint,a=s.dotSize||this.styles.dotSize,o=i?a*1.3:a,h=s.markerStyle||this.styles.markerStyle;if(h==="none"){this.renderLabel(s,n.x,n.y,0);return}this.ctx.fillStyle=s.dotColor||s.segmentColor||this.styles.dotColor,this.ctx.strokeStyle=i?"#4a90e2":"white",this.ctx.lineWidth=i?3:2,h==="square"?(this.ctx.beginPath(),this.ctx.rect(n.x-o,n.y-o,o*2,o*2),this.ctx.fill(),this.ctx.stroke()):h==="flag"?(this.ctx.beginPath(),this.ctx.moveTo(n.x,n.y-o*2),this.ctx.lineTo(n.x,n.y+o),this.ctx.moveTo(n.x,n.y-o*2),this.ctx.lineTo(n.x+o*1.5,n.y-o*1.3),this.ctx.lineTo(n.x+o*1.2,n.y-o),this.ctx.lineTo(n.x,n.y-o*.7),this.ctx.closePath(),this.ctx.fill(),this.ctx.stroke()):(this.ctx.beginPath(),this.ctx.arc(n.x,n.y,o,0,Math.PI*2),this.ctx.fill(),this.ctx.stroke()),this.renderLabel(s,n.x,n.y,o)}}),this.ctx=t}renderLabel(e,t,s,n){if(!e.label||e.labelMode==="none")return;let i=this.waypoints.indexOf(e),a=this.pathPoints.length,o=0;i<this.waypoints.length-1?o=i/(this.waypoints.length-1)*a:o=a;let h=a*this.animationEngine.getProgress(),r=a*.02,l=0;switch(e.labelMode){case"on":l=1;break;case"fade":if(h<o)return;let p=h-o;if(p<=r/2)l=Math.min(1,p/(r/2)),l=Math.pow(l,.5);else if(p<=r*3)l=1;else if(p<=r*4)l=1-Math.min(1,(p-r*3)/r);else return;break;case"persist":let m=o-h;if(m>r)return;if(m>0){let f=1-m/r;l=Math.pow(f,.5)}else l=1;break;default:return}this.ctx.save(),this.ctx.globalAlpha=Math.max(.15,l),this.ctx.font="bold 16px Arial";let u=l<1?Math.max(0,1-l)*60:0;this.ctx.fillStyle="rgb(".concat(255-u,", ").concat(255-u,", 255)"),this.ctx.strokeStyle="#000",this.ctx.lineWidth=3,this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.shadowColor="rgba(0, 0, 0, 0.7)",this.ctx.shadowBlur=5,this.ctx.shadowOffsetX=2,this.ctx.shadowOffsetY=2;let c=S.LABEL_OFFSET_X,g=e.labelPosition||"auto",y=t,d=s;switch(g){case"top":d=s-n-c;break;case"right":y=t+n+c,this.ctx.textAlign="left";break;case"bottom":d=s+n+c;break;case"left":y=t-n-c,this.ctx.textAlign="right";break;case"auto":default:let p=this.displayWidth||this.canvas.width,m=this.displayHeight||this.canvas.height;d=s-n-c,d<30&&(d=s+n+c),t<100?(y=t+n+c,this.ctx.textAlign="left"):t>p-100&&(y=t-n-c,this.ctx.textAlign="right");break}this.ctx.strokeText(e.label,y,d),this.ctx.fillText(e.label,y,d),this.ctx.restore()}loadImageFile(e){return new Promise((t,s)=>{let n=URL.createObjectURL(e),i=new Image;i.onload=()=>{URL.revokeObjectURL(n),t(i)},i.onerror=s,i.src=n})}loadDefaultImage(){let e=new Image;e.onload=()=>{this.background.image=e,this.updateImageTransform(e),this.waypoints.length>=2&&this.calculatePath(),this.render(),console.log("Default image (UoN_map.png) loaded for dev testing")},e.onerror=t=>{console.warn("Could not load default image:",t),this.render()},e.src="./UoN_map.png"}applyLineStyle(e){switch(e){case"dotted":this.ctx.setLineDash([2,6]);break;case"dashed":this.ctx.setLineDash([10,5]);break;case"squiggle":this.ctx.setLineDash([5,3,2,3]);break;case"solid":default:this.ctx.setLineDash([]);break}}drawPathHead(e,t,s){if(!isFinite(e)||!isFinite(t)){console.warn("Invalid path head coordinates:",{x:e,y:t});return}let n=this.styles.pathHead,i=n.size;switch(this.ctx.save(),this.ctx.translate(e,t),this.ctx.rotate(s),n.style){case"dot":this.ctx.beginPath(),this.ctx.fillStyle=n.color,this.ctx.arc(0,0,i/2,0,Math.PI*2),this.ctx.fill();break;case"arrow":this.ctx.beginPath(),this.ctx.fillStyle=n.color,this.ctx.moveTo(i,0),this.ctx.lineTo(-i/2,i/2),this.ctx.lineTo(-i/4,0),this.ctx.lineTo(-i/2,-i/2),this.ctx.closePath(),this.ctx.fill();break;case"custom":if(n.image){let a=i*2;this.ctx.drawImage(n.image,-a/2,-a/2,a,a)}else this.ctx.beginPath(),this.ctx.fillStyle=n.color,this.ctx.arc(0,0,i/2,0,Math.PI*2),this.ctx.fill();break;default:this.ctx.beginPath(),this.ctx.fillStyle=n.color,this.ctx.arc(0,0,i/2,0,Math.PI*2),this.ctx.fill()}this.ctx.restore()}drawBeacon(e){let t=e.beaconStyle||"none",s=e.beaconColor||this.styles.beaconColor;if(t!=="none"){if(!isFinite(e.x)||!isFinite(e.y)){console.warn("Invalid beacon coordinates:",e);return}if(t==="pulse"){this.beaconAnimation.pulsePhase=performance.now()*.003;let n=1+Math.sin(this.beaconAnimation.pulsePhase)*.3,i=S.BEACON_PULSE_SIZE*n;this.ctx.beginPath(),this.ctx.arc(e.x,e.y,i,0,Math.PI*2),this.ctx.fillStyle=s,this.ctx.globalAlpha=S.BEACON_PULSE_OPACITY,this.ctx.fill(),this.beaconAnimation.pulsePhase=(this.beaconAnimation.pulsePhase+.1)%(Math.PI*2)}else if(t==="ripple"){let n=Date.now();(!e.lastRipple||n-e.lastRipple>S.BEACON_RIPPLE_INTERVAL)&&(this.beaconAnimation.ripples.push({x:e.x,y:e.y,radius:0,opacity:.5,startTime:n,color:s}),e.lastRipple=n),this.beaconAnimation.ripples=this.beaconAnimation.ripples.filter(i=>{let a=n-i.startTime;if(a>S.BEACON_RIPPLE_DURATION)return!1;let o=a/S.BEACON_RIPPLE_SPEED,h=a/S.BEACON_RIPPLE_DURATION,r=.5*(1-I.cubicOut(h));return this.ctx.beginPath(),this.ctx.arc(i.x,i.y,o,0,Math.PI*2),this.ctx.strokeStyle=i.color,this.ctx.lineWidth=2,this.ctx.globalAlpha=r,this.ctx.stroke(),!0}),this.ctx.beginPath(),this.ctx.fillStyle=s,this.ctx.globalAlpha=.8,this.ctx.arc(e.x,e.y,6,0,Math.PI*2),this.ctx.fill()}this.ctx.globalAlpha=1}}destroy(){var e,t,s,n,i;if((e=this.animationEngine)==null||e.stop(),(t=this.interactionHandler)==null||t.destroy(),(s=this.pathCalculator)==null||s.destroy(),(n=this.eventBus)==null||n.removeAll(),this.renderQueued&&(cancelAnimationFrame(this.renderQueued),this.renderQueued=!1),this._durationUpdateTimeout&&clearTimeout(this._durationUpdateTimeout),(i=this.ctx)==null||i.clearRect(0,0,this.canvas.width,this.canvas.height),this.vectorCanvas){let a=this.vectorCanvas.getContext("2d");a==null||a.clearRect(0,0,this.vectorCanvas.width,this.vectorCanvas.height)}this.waypoints=null,this.pathPoints=null,this.selectedWaypoint=null,this.waypointsById=null,this.background=null,this.elements=null,console.log("Route Plotter destroyed")}};document.addEventListener("DOMContentLoaded",()=>{window.app=new V});
//# sourceMappingURL=app.js.map
